{"version":3,"file":"src_avformat_formats_OMpegtsFormat_ts.avtranscoder.js","mappings":"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","sources":["webpack://AVTranscoder/./src/avformat/bsf/AVBSFilter.ts","webpack://AVTranscoder/./src/avformat/bsf/aac/Raw2ADTSFilter.ts","webpack://AVTranscoder/./src/avformat/bsf/aac/Raw2LATMFilter.ts","webpack://AVTranscoder/./src/avformat/bsf/h2645/Avcc2AnnexbFilter.ts","webpack://AVTranscoder/./src/avformat/bsf/opus/Raw2MpegtsFilter.ts","webpack://AVTranscoder/./src/avformat/codecs/opus.ts","webpack://AVTranscoder/./src/avformat/codecs/vvc.ts","webpack://AVTranscoder/./src/avformat/formats/OMpegtsFormat.ts","webpack://AVTranscoder/./src/avformat/formats/mpegts/function/crc32.ts","webpack://AVTranscoder/./src/avformat/formats/mpegts/function/createMpegtsContext.ts","webpack://AVTranscoder/./src/avformat/formats/mpegts/function/createMpegtsStreamContext.ts","webpack://AVTranscoder/./src/avformat/formats/mpegts/mpegts.ts","webpack://AVTranscoder/./src/avformat/formats/mpegts/ompegts.ts","webpack://AVTranscoder/./src/avformat/formats/mpegts/struct.ts","webpack://AVTranscoder/./src/avformat/function/mktag.ts"],"sourcesContent":["/*\r\n * libmedia AVBSFilter\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport AVPacket from 'avutil/struct/avpacket'\r\nimport AVCodecParameters from 'avutil/struct/avcodecparameters'\r\nimport { Rational } from 'avutil/struct/rational'\r\nimport { avMallocz } from 'avutil/util/mem'\r\nimport { copyCodecParameters, freeCodecParameters } from 'avutil/util/codecparameters'\r\n\r\nexport default abstract class AVBSFilter {\r\n\r\n  inCodecpar: pointer<AVCodecParameters>\r\n  inTimeBase: Rational\r\n\r\n  outCodecpar: pointer<AVCodecParameters>\r\n\r\n  public init(codecpar: pointer<AVCodecParameters>, timeBase: pointer<Rational>): number {\r\n    this.inCodecpar = avMallocz(sizeof(AVCodecParameters))\r\n    copyCodecParameters(this.inCodecpar, codecpar)\r\n\r\n    this.inTimeBase = {\r\n      den: timeBase.den,\r\n      num: timeBase.num\r\n    }\r\n\r\n    return 0\r\n  }\r\n\r\n  public destroy() {\r\n    if (this.inCodecpar) {\r\n      freeCodecParameters(this.inCodecpar)\r\n      this.inCodecpar = nullptr\r\n    }\r\n  }\r\n\r\n  public abstract sendAVPacket(avpacket: pointer<AVPacket>): number\r\n  public abstract receiveAVPacket(avpacket: pointer<AVPacket>): number\r\n}\r\n","/*\r\n * libmedia Raw2ADTSFilter\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport AVPacket from 'avutil/struct/avpacket'\r\nimport AVBSFilter from '../AVBSFilter'\r\nimport AVCodecParameters from 'avutil/struct/avcodecparameters'\r\nimport { Rational } from 'avutil/struct/rational'\r\nimport { MPEG4SamplingFrequencyIndex } from '../../codecs/aac'\r\nimport { mapUint8Array } from 'cheap/std/memory'\r\nimport { addAVPacketData, copyAVPacketProps, createAVPacket,\r\n  destroyAVPacket, refAVPacket, unrefAVPacket\r\n} from 'avutil/util/avpacket'\r\nimport { avMalloc } from 'avutil/util/mem'\r\nimport * as errorType from 'avutil/error'\r\n\r\nexport default class Raw2ADTSFilter extends AVBSFilter {\r\n\r\n  private cache: pointer<AVPacket>\r\n  private cached: boolean\r\n\r\n  public init(codecpar: pointer<AVCodecParameters>, timeBase: pointer<Rational>): number {\r\n    super.init(codecpar, timeBase)\r\n    this.cache = createAVPacket()\r\n\r\n    return 0\r\n  }\r\n\r\n  public destroy(): void {\r\n    super.destroy()\r\n    destroyAVPacket(this.cache)\r\n    this.cache = nullptr\r\n    this.cached = false\r\n  }\r\n\r\n  public sendAVPacket(avpacket: pointer<AVPacket>): number {\r\n    if (!avpacket.data || !avpacket.size) {\r\n      return\r\n    }\r\n\r\n    const size = 7 + avpacket.size\r\n    const bufferPointer = avMalloc(size)\r\n    const buffer = mapUint8Array(bufferPointer, size)\r\n\r\n    // syncword 0xfff\r\n    buffer[0] = 0xff\r\n    buffer[1] = 0xf0\r\n\r\n    // ID\r\n    buffer[1] |= 1 << 3\r\n\r\n    // Protection Absent\r\n    buffer[1] |= 1\r\n\r\n    // profile\r\n    buffer[2] = ((this.inCodecpar.profile - 1) & 0x03) << 6\r\n\r\n    // Sampling Frequency Index\r\n    buffer[2] |= (MPEG4SamplingFrequencyIndex[this.inCodecpar.sampleRate] & 0x0f) << 2\r\n\r\n    // Channel Configuration \r\n    buffer[2] |= (this.inCodecpar.chLayout.nbChannels & 0x04) >> 2\r\n\r\n    // Channel Configuration \r\n    buffer[3] = (this.inCodecpar.chLayout.nbChannels & 0x03) << 6\r\n\r\n    // Frame Length  2 \r\n    buffer[3] |= (buffer.length >> 11) & 0x03\r\n\r\n    // Frame Length  8 \r\n    buffer[4] = (buffer.length >> 3) & 0xff\r\n\r\n    // Frame Length  3 \r\n    buffer[5] = (buffer.length & 0x07) << 5\r\n\r\n    // Buffer Fullness  1\r\n    buffer[5] |= 0x1f\r\n    buffer[6] = 0xfc\r\n\r\n    buffer.set(mapUint8Array(avpacket.data, avpacket.size), 7)\r\n\r\n    copyAVPacketProps(this.cache, avpacket)\r\n    addAVPacketData(this.cache, bufferPointer, size)\r\n    this.cached = true\r\n  }\r\n\r\n  public receiveAVPacket(avpacket: pointer<AVPacket>): number {\r\n    if (this.cached) {\r\n      unrefAVPacket(avpacket)\r\n      refAVPacket(avpacket, this.cache)\r\n      this.cached = false\r\n      return 0\r\n    }\r\n    else {\r\n      return errorType.EOF\r\n    }\r\n  }\r\n}\r\n","/*\r\n * libmedia Raw2LATMFilter\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport AVPacket from 'avutil/struct/avpacket'\r\nimport AVBSFilter from '../AVBSFilter'\r\nimport AVCodecParameters from 'avutil/struct/avcodecparameters'\r\nimport { Rational } from 'avutil/struct/rational'\r\nimport { MPEG4SamplingFrequencyIndex, getAVCodecParameters } from '../../codecs/aac'\r\nimport { mapUint8Array } from 'cheap/std/memory'\r\nimport { addAVPacketData, copyAVPacketProps, createAVPacket,\r\n  destroyAVPacket, getAVPacketSideData, refAVPacket, unrefAVPacket\r\n} from 'avutil/util/avpacket'\r\nimport { avMalloc } from 'avutil/util/mem'\r\nimport * as errorType from 'avutil/error'\r\nimport * as object from 'common/util/object'\r\nimport BitWriter from 'common/io/BitWriter'\r\nimport { AVPacketSideDataType } from 'avutil/codec'\r\n\r\nexport interface AACRaw2LATMFilterOptions {\r\n  mod?: number\r\n}\r\n\r\nconst defaultAACRaw2LATMFilterOptions = {\r\n  mod: 20\r\n}\r\n\r\nconst LATM_HEADER = new Uint8Array([0x56, 0xe0, 0x00])\r\n\r\nexport default class Raw2LATMFilter extends AVBSFilter {\r\n  private cache: pointer<AVPacket>\r\n  private cached: boolean\r\n  private bitWriter: BitWriter\r\n  private counter: number\r\n\r\n  private options: AACRaw2LATMFilterOptions\r\n\r\n  constructor(options: AACRaw2LATMFilterOptions = {}) {\r\n    super()\r\n    this.options = object.extend({}, defaultAACRaw2LATMFilterOptions, options)\r\n  }\r\n\r\n  public init(codecpar: pointer<AVCodecParameters>, timeBase: pointer<Rational>): number {\r\n    super.init(codecpar, timeBase)\r\n    this.cache = createAVPacket()\r\n    this.cached = false\r\n\r\n    this.counter = 0\r\n    this.bitWriter = new BitWriter()\r\n\r\n    return 0\r\n  }\r\n\r\n  public destroy(): void {\r\n    super.destroy()\r\n    destroyAVPacket(this.cache)\r\n    this.cache = nullptr\r\n  }\r\n\r\n  private writeHeader() {\r\n    this.bitWriter.writeU1(this.counter === 0 ? 0 : 1)\r\n\r\n    // StreamMuxConfig\r\n    if (this.counter === 0) {\r\n      // audioMuxVersion\r\n      this.bitWriter.writeU1(0)\r\n      // allStreamsSameTimeFraming\r\n      this.bitWriter.writeU1(1)\r\n      // numSubFrames\r\n      this.bitWriter.writeU(6, 0)\r\n      // numProgram\r\n      this.bitWriter.writeU(4, 0)\r\n      // numLayer\r\n      this.bitWriter.writeU(3, 0)\r\n\r\n      // profile\r\n      this.bitWriter.writeU(5, (this.inCodecpar.profile - 1) & 0x1f)\r\n      // samplingFreqIndex\r\n      this.bitWriter.writeU(4, MPEG4SamplingFrequencyIndex[this.inCodecpar.sampleRate] & 0x0f)\r\n      // channelConfig\r\n      this.bitWriter.writeU(4, this.inCodecpar.chLayout.nbChannels & 0x0f)\r\n      // padding\r\n      this.bitWriter.writeU(3, 0)\r\n\r\n      // frameLengthType\r\n      this.bitWriter.writeU(3, 0)\r\n\r\n      // latmBufferFullness\r\n      this.bitWriter.writeU(8, 0xff)\r\n\r\n      // otherDataPresent\r\n      this.bitWriter.writeU1(0)\r\n\r\n      // crcCheckPresent\r\n      this.bitWriter.writeU1(0)\r\n\r\n    }\r\n\r\n    this.counter++\r\n    this.counter %= this.options.mod\r\n  }\r\n\r\n  private copyBytes(data: Uint8Array) {\r\n    for (let i = 0; i < data.length; i++) {\r\n      this.bitWriter.writeU(8, data[i])\r\n    }\r\n  }\r\n\r\n  public sendAVPacket(avpacket: pointer<AVPacket>): number {\r\n    if (!avpacket.data || !avpacket.size) {\r\n      return\r\n    }\r\n\r\n    this.bitWriter.clear()\r\n\r\n    const element = getAVPacketSideData(avpacket, AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA)\r\n    if (element) {\r\n      const { profile, sampleRate, channels } = getAVCodecParameters(mapUint8Array(element.data, element.size))\r\n      this.inCodecpar.profile = profile\r\n      this.inCodecpar.sampleRate = sampleRate\r\n      this.inCodecpar.chLayout.nbChannels = channels\r\n      this.counter = 0\r\n    }\r\n\r\n    this.writeHeader()\r\n\r\n    let i = 0\r\n    for (; i <= avpacket.size - 255; i += 255) {\r\n      this.bitWriter.writeU(8, 255)\r\n    }\r\n    this.bitWriter.writeU(8, avpacket.size - i)\r\n\r\n    const packetBuffer = mapUint8Array(avpacket.data, avpacket.size)\r\n\r\n    if ((packetBuffer[0] & 0xe1) === 0x81) {\r\n      /*\r\n       * Convert byte-aligned DSE to non-aligned.\r\n       * Due to the input format encoding we know that\r\n       * it is naturally byte-aligned in the input stream,\r\n       * so there are no padding bits to account for.\r\n       * To avoid having to add padding bits and rearrange\r\n       * the whole stream we just remove the byte-align flag.\r\n       * This allows us to remux our FATE AAC samples into latm\r\n       * files that are still playable with minimal effort.\r\n       */\r\n\r\n      this.bitWriter.writeU(8, packetBuffer[0] & 0xfe)\r\n      this.copyBytes(packetBuffer.subarray(1))\r\n    }\r\n    else {\r\n      this.copyBytes(packetBuffer)\r\n    }\r\n\r\n    this.bitWriter.padding()\r\n\r\n    const len = this.bitWriter.getPointer()\r\n\r\n    const size = 3 + len\r\n    const bufferPointer = avMalloc(size)\r\n    const buffer = mapUint8Array(bufferPointer, size)\r\n    buffer.set(LATM_HEADER, 0)\r\n\r\n    buffer[1] |= (len >> 8) & 0x1f\r\n    buffer[2] |= len & 0xff\r\n\r\n    buffer.set(this.bitWriter.getBuffer().subarray(0, len), 3)\r\n\r\n    copyAVPacketProps(this.cache, avpacket)\r\n    addAVPacketData(this.cache, bufferPointer, size)\r\n    this.cached = true\r\n  }\r\n\r\n  public receiveAVPacket(avpacket: pointer<AVPacket>): number {\r\n    if (this.cached) {\r\n      unrefAVPacket(avpacket)\r\n      refAVPacket(avpacket, this.cache)\r\n      this.cached = false\r\n      return 0\r\n    }\r\n    else {\r\n      return errorType.EOF\r\n    }\r\n  }\r\n}\r\n","/*\r\n * libmedia Avcc2AnnexbFilter\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport AVPacket, { AVPacketFlags } from 'avutil/struct/avpacket'\r\nimport AVBSFilter from '../AVBSFilter'\r\nimport AVCodecParameters from 'avutil/struct/avcodecparameters'\r\nimport { Rational } from 'avutil/struct/rational'\r\nimport { addAVPacketData, copyAVPacketProps, createAVPacket, destroyAVPacket,\r\n  getAVPacketSideData,\r\n  refAVPacket, unrefAVPacket\r\n} from 'avutil/util/avpacket'\r\n\r\nimport * as h264 from '../../codecs/h264'\r\nimport * as hevc from '../../codecs/hevc'\r\nimport * as vvc from '../../codecs/vvc'\r\nimport { AVCodecID, AVPacketSideDataType } from 'avutil/codec'\r\nimport * as errorType from 'avutil/error'\r\nimport { isAnnexb } from 'avutil/util/nalu'\r\nimport * as logger from 'common/util/logger'\r\nimport { mapSafeUint8Array } from 'cheap/std/memory'\r\n\r\nexport default class Avcc2AnnexbFilter extends AVBSFilter {\r\n  private cache: pointer<AVPacket>\r\n  private cached: boolean\r\n\r\n  public init(codecpar: pointer<AVCodecParameters>, timeBase: pointer<Rational>): number {\r\n    super.init(codecpar, timeBase)\r\n    this.cache = createAVPacket()\r\n    this.cached = false\r\n    return 0\r\n  }\r\n\r\n  public destroy(): void {\r\n    super.destroy()\r\n    destroyAVPacket(this.cache)\r\n    this.cache = nullptr\r\n  }\r\n\r\n  public sendAVPacket(avpacket: pointer<AVPacket>): number {\r\n    const buffer = mapSafeUint8Array(avpacket.data, avpacket.size)\r\n\r\n    if (avpacket.bitFormat === h264.BitFormat.ANNEXB || isAnnexb(buffer)) {\r\n      refAVPacket(this.cache, avpacket)\r\n    }\r\n    else {\r\n      copyAVPacketProps(this.cache, avpacket)\r\n\r\n      let convert: {\r\n        bufferPointer: pointer<uint8>,\r\n        length: size,\r\n        key: boolean\r\n      }\r\n\r\n      const element = getAVPacketSideData(avpacket, AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA)\r\n      let extradata = null\r\n      if (element) {\r\n        extradata = mapSafeUint8Array(element.data, element.size)\r\n      }\r\n\r\n      if (this.inCodecpar.codecId === AVCodecID.AV_CODEC_ID_H264) {\r\n        convert = h264.avcc2Annexb(buffer, extradata)\r\n      }\r\n      else if (this.inCodecpar.codecId === AVCodecID.AV_CODEC_ID_HEVC) {\r\n        convert = hevc.avcc2Annexb(buffer, extradata)\r\n      }\r\n      else if (this.inCodecpar.codecId === AVCodecID.AV_CODEC_ID_VVC) {\r\n        convert = vvc.avcc2Annexb(buffer, extradata)\r\n      }\r\n      else {\r\n        logger.fatal(`not support for codecId: ${this.inCodecpar.codecId}`)\r\n      }\r\n\r\n      this.cache.bitFormat = h264.BitFormat.ANNEXB\r\n\r\n      addAVPacketData(this.cache, convert.bufferPointer, convert.length)\r\n\r\n      if (convert.key) {\r\n        this.cache.flags |= AVPacketFlags.AV_PKT_FLAG_KEY\r\n      }\r\n    }\r\n    this.cached = true\r\n    return 0\r\n  }\r\n\r\n  public receiveAVPacket(avpacket: pointer<AVPacket>): number {\r\n    if (this.cached) {\r\n      unrefAVPacket(avpacket)\r\n      refAVPacket(avpacket, this.cache)\r\n      this.cached = false\r\n      return 0\r\n    }\r\n    else {\r\n      return errorType.DATA_INVALID\r\n    }\r\n  }\r\n}\r\n","/*\r\n * libmedia Raw2MpegtsFilter\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport AVPacket from 'avutil/struct/avpacket'\r\nimport AVBSFilter from '../AVBSFilter'\r\nimport AVCodecParameters from 'avutil/struct/avcodecparameters'\r\nimport { Rational } from 'avutil/struct/rational'\r\nimport { mapUint8Array } from 'cheap/std/memory'\r\nimport { addAVPacketData, copyAVPacketProps, createAVPacket,\r\n  destroyAVPacket, getAVPacketSideData, refAVPacket, unrefAVPacket\r\n} from 'avutil/util/avpacket'\r\nimport { avMalloc } from 'avutil/util/mem'\r\nimport * as errorType from 'avutil/error'\r\nimport * as opus from '../../codecs/opus'\r\nimport { AVPacketSideDataType } from 'avutil/codec'\r\n\r\nexport default class Raw2MpegtsFilter extends AVBSFilter {\r\n\r\n  private cache: pointer<AVPacket>\r\n\r\n  private cached: boolean\r\n\r\n  private opusPendingTrimStart: number\r\n\r\n  public init(codecpar: pointer<AVCodecParameters>, timeBase: pointer<Rational>): number {\r\n\r\n    super.init(codecpar, timeBase)\r\n    this.cache = createAVPacket()\r\n    this.cached = false\r\n\r\n    this.opusPendingTrimStart = (this.inCodecpar.initialPadding > 0 ? this.inCodecpar.initialPadding : 0)\r\n    * 48000 / this.inCodecpar.sampleRate\r\n\r\n    return 0\r\n  }\r\n\r\n  public destroy(): void {\r\n    super.destroy()\r\n    destroyAVPacket(this.cache)\r\n    this.cache = nullptr\r\n  }\r\n\r\n  public sendAVPacket(avpacket: pointer<AVPacket>): number {\r\n    if (!avpacket.data || !avpacket.size) {\r\n      return\r\n    }\r\n\r\n    const packetBuffer = mapUint8Array(avpacket.data, avpacket.size)\r\n\r\n    const opusSamples = opus.getBufferSamples(packetBuffer)\r\n    let sideData = null\r\n    const element = getAVPacketSideData(avpacket, AVPacketSideDataType.AV_PKT_DATA_SKIP_SAMPLES)\r\n    if (element) {\r\n      sideData = mapUint8Array(element.data, element.size)\r\n    }\r\n    let trimEnd = 0\r\n\r\n    if (sideData && sideData.length >= 10) {\r\n      const value = (sideData[4] << 24) | (sideData[5] << 16) | (sideData[6] << 8) | sideData[9]\r\n      trimEnd = value * 48000 / this.inCodecpar.sampleRate\r\n    }\r\n\r\n    let ctrlHeaderSize = packetBuffer.length + 2 + packetBuffer.length / 255 + 1\r\n    if (this.opusPendingTrimStart) {\r\n      ctrlHeaderSize += 2\r\n    }\r\n    if (trimEnd) {\r\n      ctrlHeaderSize += 2\r\n    }\r\n\r\n    const bufferPointer = avMalloc(ctrlHeaderSize)\r\n    const buffer = mapUint8Array(bufferPointer, ctrlHeaderSize)\r\n\r\n    buffer[0] = 0x7f\r\n    buffer[1] = 0xe0\r\n    if (this.opusPendingTrimStart) {\r\n      buffer[1] |= 0x10\r\n    }\r\n\r\n    if (trimEnd) {\r\n      buffer[1] |= 0x08\r\n    }\r\n\r\n    let n = packetBuffer.length\r\n    let i = 2\r\n    do {\r\n      buffer[i] = Math.min(n, 255)\r\n      n -= 255\r\n      i++\r\n    }\r\n    while (n >= 0)\r\n\r\n    let trimStart = 0\r\n    if (this.opusPendingTrimStart) {\r\n      trimStart = Math.min(this.opusPendingTrimStart, opusSamples)\r\n      buffer[i] = (trimStart & 0xff00) >> 8\r\n      buffer[i + 1] = trimStart & 0xff\r\n      i += 2\r\n      this.opusPendingTrimStart -= trimStart\r\n    }\r\n    if (trimEnd) {\r\n      trimEnd = Math.min(trimEnd, opusSamples - trimStart)\r\n      buffer[i] = (trimEnd & 0xff00) >> 8\r\n      buffer[i + 1] = trimEnd & 0xff\r\n      i += 2\r\n    }\r\n\r\n    buffer.set(packetBuffer, i)\r\n\r\n    copyAVPacketProps(this.cache, avpacket)\r\n    addAVPacketData(this.cache, bufferPointer, ctrlHeaderSize)\r\n    this.cached = true\r\n    return 0\r\n  }\r\n\r\n  public receiveAVPacket(avpacket: pointer<AVPacket>): number {\r\n    if (this.cached) {\r\n      unrefAVPacket(avpacket)\r\n      refAVPacket(avpacket, this.cache)\r\n      this.cached = false\r\n      return 0\r\n    }\r\n    else {\r\n      return errorType.DATA_INVALID\r\n    }\r\n  }\r\n}\r\n","/*\r\n * libmedia opus util\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport { AVPacketSideDataType } from 'avutil/codec'\r\nimport AVStream from '../AVStream'\r\nimport AVCodecParameters from 'avutil/struct/avcodecparameters'\r\nimport BufferReader from 'common/io/BufferReader'\r\nimport BufferWriter from 'common/io/BufferWriter'\r\nimport { avRescaleQ } from 'avutil/util/rational'\r\nimport { Uint8ArrayInterface } from 'common/io/interface'\r\n\r\nexport const durations = [\r\n  /* Silk NB */\r\n  480, 960, 1920, 2880,\r\n  /* Silk MB */\r\n  480, 960, 1920, 2880,\r\n  /* Silk WB */\r\n  480, 960, 1920, 2880,\r\n  /* Hybrid SWB */\r\n  480, 960,\r\n  /* Hybrid FB */\r\n  480, 960,\r\n  /* CELT NB */\r\n  120, 240, 480, 960,\r\n  /* CELT NB */\r\n  120, 240, 480, 960,\r\n  /* CELT NB */\r\n  120, 240, 480, 960,\r\n  /* CELT NB */\r\n  120, 240, 480, 960\r\n]\r\n\r\n\r\nexport function getBufferSamples(buffer: Uint8Array) {\r\n  let toc = 0, frameDuration = 0, nframes = 0\r\n\r\n  if (buffer.length < 1) {\r\n    return 0\r\n  }\r\n\r\n  toc = buffer[0]\r\n\r\n  frameDuration = durations[toc >> 3]\r\n\r\n  switch (toc & 3) {\r\n    case 0:\r\n      nframes = 1\r\n      break\r\n    case 1:\r\n      nframes = 2\r\n      break\r\n    case 2:\r\n      nframes = 2\r\n      break\r\n    case 3:\r\n      if (buffer.length < 2) {\r\n        return 0\r\n      }\r\n      nframes = buffer[1] & 63\r\n      break\r\n  }\r\n  return nframes * frameDuration\r\n}\r\n\r\n/**\r\n * opus extradata\r\n * \r\n * - 8 bytes Magic Signature: OpusHead\r\n * - 1 bytes unsigned,  0x01 version\r\n * - 1 bytes unsigned, channels   packet-by-packet,  0x01\r\n * - 2 bytes unsigned, preSkip   PCM \r\n * - 4 bytes unsigned, sampleRate \r\n * - 2 bytes signed, outputGain  20 * log10 \r\n * - 1 bytes unsigned, channelMappingFamily \r\n * - channelMappingTable   Channel Mapping Family  0 \r\n *  - 1 bytes, streamCount, unsigned ogg packet  stream\r\n *  - 1 bytes, coupledStreamCount, unsigned  streamCount\r\n *  - C bytes, C  coupledStreamCount + streamCount\r\n * \r\n */\r\nexport function parseAVCodecParameters(stream: AVStream, extradata?: Uint8ArrayInterface) {\r\n  if (!extradata && stream.sideData[AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA]) {\r\n    extradata = stream.sideData[AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA]\r\n  }\r\n  if (extradata && extradata.length >= 19) {\r\n    const reader = new BufferReader(extradata, false)\r\n    reader.skip(9)\r\n    stream.codecpar.chLayout.nbChannels = reader.readUint8()\r\n    stream.codecpar.initialPadding = reader.readUint16()\r\n    stream.codecpar.sampleRate = reader.readUint32()\r\n\r\n    stream.codecpar.seekPreroll = Number(avRescaleQ(\r\n      80n,\r\n      {\r\n        den: 1000,\r\n        num: 1\r\n      },\r\n      {\r\n        den: 48000,\r\n        num: 1\r\n      }\r\n    ))\r\n  }\r\n}\r\n\r\nexport function avCodecParameters2Extradata(codecpar: AVCodecParameters) {\r\n  const extradata = new Uint8Array(19)\r\n\r\n  const writer = new BufferWriter(extradata, false)\r\n\r\n  writer.writeString('OpusHead')\r\n  writer.writeUint8(0x01)\r\n  writer.writeUint8(codecpar.chLayout.nbChannels)\r\n  writer.writeUint16(codecpar.initialPadding)\r\n  writer.writeUint32(codecpar.sampleRate)\r\n\r\n  return extradata\r\n}\r\n","/*\r\n * libmedia vvc util\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport * as array from 'common/util/array'\r\nimport AVPacket, { AVPacketFlags } from 'avutil/struct/avpacket'\r\nimport BufferWriter from 'common/io/BufferWriter'\r\nimport BufferReader from 'common/io/BufferReader'\r\nimport { AVPacketSideDataType } from 'avutil/codec'\r\nimport BitReader from 'common/io/BitReader'\r\nimport AVStream from '../AVStream'\r\nimport { mapUint8Array, memcpyFromUint8Array } from 'cheap/std/memory'\r\nimport { naluUnescape, splitNaluByStartCode, isAnnexb } from 'avutil/util/nalu'\r\nimport { addAVPacketSideData, getAVPacketData } from 'avutil/util/avpacket'\r\nimport { avMalloc } from 'avutil/util/mem'\r\nimport * as expgolomb from 'avutil/util/expgolomb'\r\nimport { Uint8ArrayInterface } from 'common/io/interface'\r\nimport BitWriter from 'common/io/BitWriter'\r\nimport { Data } from 'common/types/type'\r\nimport { BitFormat } from './h264'\r\nimport * as intread from 'avutil/util/intread'\r\n\r\nconst NALULengthSizeMinusOne = 3\r\n\r\nexport const enum VVCNaluType {\r\n  kTRAIL_NUT      = 0,\r\n  kSTSA_NUT       = 1,\r\n  kRADL_NUT       = 2,\r\n  kRASL_NUT       = 3,\r\n  kRSV_VCL_4      = 4,\r\n  kRSV_VCL_5      = 5,\r\n  kRSV_VCL_6      = 6,\r\n  kIDR_W_RADL     = 7,\r\n  kIDR_N_LP       = 8,\r\n  kCRA_NUT        = 9,\r\n  kGDR_NUT        = 10,\r\n  kRSV_IRAP_11    = 11,\r\n  kOPI_NUT        = 12,\r\n  kDCI_NUT        = 13,\r\n  kVPS_NUT        = 14,\r\n  kSPS_NUT        = 15,\r\n  kPPS_NUT        = 16,\r\n  kPREFIX_APS_NUT = 17,\r\n  kSUFFIX_APS_NUT = 18,\r\n  kPH_NUT         = 19,\r\n  kAUD_NUT        = 20,\r\n  kEOS_NUT        = 21,\r\n  kEOB_NUT        = 22,\r\n  kPREFIX_SEI_NUT = 23,\r\n  kSUFFIX_SEI_NUT = 24,\r\n  kFD_NUT         = 25,\r\n  kRSV_NVCL_26    = 26,\r\n  kRSV_NVCL_27    = 27,\r\n  kUNSPEC_28      = 28,\r\n  kUNSPEC_29      = 29,\r\n  kUNSPEC_30      = 30,\r\n  kUNSPEC_31      = 31,\r\n}\r\n\r\nexport const enum VVCSliceType {\r\n  kSliceNone = -1,\r\n  kSliceB = 0,\r\n  kSliceP = 1,\r\n  kSliceI = 2\r\n}\r\n\r\nexport const enum VVCAPSType {\r\n  kALF     = 0,\r\n  kLMCS    = 1,\r\n  kSCALING = 2\r\n}\r\n\r\nfunction parsePTL(bitReader: BitReader) {\r\n  const olsIdx = bitReader.readU(9)\r\n  const numSublayers = bitReader.readU(3)\r\n  const constantFrameRate = bitReader.readU(2)\r\n  const chromaFormatIdc = bitReader.readU(2)\r\n  const bitDepthMinus8 = bitReader.readU(3)\r\n  bitReader.readU(5)\r\n\r\n  // VvcPTLRecord\r\n  bitReader.readU(2)\r\n  const num_bytes_constraint_info = bitReader.readU(6)\r\n  const generalProfileIdc = bitReader.readU(7)\r\n  const generalTierFlag = bitReader.readU(1)\r\n  const generalLevelIdc = bitReader.readU(8)\r\n  const ptlFrameOnlyConstraintFlag = bitReader.readU(1)\r\n  const ptlMultilayerEnabledFlag = bitReader.readU(1)\r\n  const generalConstraintInfo = []\r\n  const sublayerLevelIdc = []\r\n\r\n  if (num_bytes_constraint_info) {\r\n    for (let i = 0; i < num_bytes_constraint_info - 1; i++) {\r\n      generalConstraintInfo[i] = bitReader.readU(8)\r\n    }\r\n    generalConstraintInfo[num_bytes_constraint_info - 1] = bitReader.readU(6)\r\n  }\r\n  else {\r\n    bitReader.readU(6)\r\n  }\r\n  if (numSublayers > 1) {\r\n    let ptl_sublayer_present_mask = 0\r\n    for (let j = numSublayers - 2; j >= 0; --j) {\r\n      const val = bitReader.readU(1)\r\n      ptl_sublayer_present_mask |= val << j\r\n    }\r\n    for (let j = numSublayers; j <= 8 && numSublayers > 1; ++j) {\r\n      bitReader.readU(1)\r\n    }\r\n    \r\n    for (let j = numSublayers - 2; j >= 0; --j) {\r\n      if (ptl_sublayer_present_mask & (1 << j)) {\r\n        sublayerLevelIdc[j] = bitReader.readU(8)\r\n      }\r\n    }\r\n  }\r\n  const ptl_num_sub_profiles = bitReader.readU(8)\r\n  const generalSubProfileIdc = []\r\n  if (ptl_num_sub_profiles) {\r\n    for (let i = 0; i < ptl_num_sub_profiles; i++) {\r\n      generalSubProfileIdc.push(bitReader.readU(8))\r\n    }\r\n  }\r\n\r\n  const maxPictureWidth = bitReader.readU(16)\r\n  const maxPictureHeight = bitReader.readU(16)\r\n  const avgFramerate = bitReader.readU(16)\r\n\r\n  return {\r\n    olsIdx,\r\n    numSublayers,\r\n    bitDepthMinus8,\r\n    chromaFormatIdc,\r\n    constantFrameRate,\r\n    generalProfileIdc,\r\n    generalTierFlag,\r\n    generalLevelIdc,\r\n    ptlFrameOnlyConstraintFlag,\r\n    ptlMultilayerEnabledFlag,\r\n    generalConstraintInfo,\r\n    sublayerLevelIdc,\r\n    generalSubProfileIdc,\r\n    maxPictureWidth,\r\n    maxPictureHeight,\r\n    avgFramerate\r\n  }\r\n}\r\n\r\n/**\r\n * \r\n * vvcc  extradata  annexb vps sps pps\r\n * \r\n * bits    \r\n * - 5   reserved (11111)\r\n * - 2   lengthSizeMinusOne\r\n * - 1   ptl_present_flag\r\n * if ptl_present_flag\r\n *   - 9   ols_idx\r\n *   - 3  num_sublayers\r\n *   - 2  constant_frame_rate\r\n *   - 2  chroma_format_idc\r\n *   - 3  bit_depth_minus8\r\n *   - 5  reserved (11111)\r\n *   VvcPTLRecord\r\n *   - 2 reserved (11)\r\n *   - 6 num_bytes_constraint_info\r\n *   - 7 general_profile_idc\r\n *   - 1 general_tier_flag\r\n *   - 8 general_level_idc\r\n *   - 1 general_level_idc\r\n *   - 1 ptl_multilayer_enabled_flag\r\n *   if num_bytes_constraint_info > 0\r\n *      for (i = 0; i < num_bytes_constraint_info - 1; i++)\r\n *        - 8 general_constraint_info[i]\r\n *      - 6 general_constraint_info[num_bytes_constraint_info - 1]\r\n *   else\r\n *      - 6 reserved\r\n *   if num_sublayers > 1\r\n *      - num_sublayers - 2 ptl_sublayer_level_present_flag\r\n *      - 8 - num_sublayers + 1 ptl_reserved_zero_bit\r\n *      for (i = num_sublayers -2; i >= 0; i--)\r\n *        if ptl_sublayer_present_mask & (1 << i)\r\n *          - 8 sublayer_level_idc[i]\r\n *    - 8 ptl_num_sub_profiles\r\n *    if ptl_num_sub_profiles\r\n *      for (i = 0; i < ptl_num_sub_profiles; i++)\r\n *        - 32 general_sub_profile_idc[i]\r\n *    - 16 max_picture_width\r\n *    - 16 max_picture_height\r\n *    - 16 avg_frame_rate\r\n * - 8   numOfArrays\r\n * - repeated of array (vps/sps/pps)\r\n * - 1   array_completeness\r\n * - 2   reserved (0)\r\n * - 5   NAL_unit_type\r\n * if nalu_type != VVC_NALU_DEC_PARAM && nalu_type != VVC_NALU_OPI\r\n *    - 16  numNalus\r\n * else\r\n *   numNalus = 1\r\n * - repeated once per NAL\r\n * - 16  nalUnitLength\r\n * - N   NALU data\r\n * \r\n */\r\nexport function extradata2VpsSpsPps(extradata: Uint8ArrayInterface) {\r\n\r\n  const bufferReader = new BufferReader(extradata, true)\r\n\r\n  const ptlPresentFlag = bufferReader.readUint8() & 0x01\r\n\r\n  if (ptlPresentFlag) {\r\n    const bitReader = new BitReader()\r\n    bitReader.appendBuffer(extradata.subarray(1))\r\n    parsePTL(bitReader)\r\n    bufferReader.skip(bitReader.getPos())\r\n  }\r\n\r\n  let vpss = []\r\n  let spss = []\r\n  let ppss = []\r\n\r\n  const arrayLen = bufferReader.readUint8()\r\n\r\n  for (let i = 0; i < arrayLen; i++) {\r\n    const naluType = bufferReader.readUint8() & 0x1f\r\n    let count = 1\r\n\r\n    if (naluType !== VVCNaluType.kDCI_NUT && naluType !== VVCNaluType.kOPI_NUT) {\r\n      count = bufferReader.readUint16()\r\n    }\r\n    const list = []\r\n\r\n    for (let j = 0; j < count; j++) {\r\n      const len = bufferReader.readUint16()\r\n      list.push(bufferReader.readBuffer(len))\r\n    }\r\n\r\n    if (naluType === VVCNaluType.kVPS_NUT) {\r\n      vpss = list\r\n    }\r\n    else if (naluType === VVCNaluType.kSPS_NUT) {\r\n      spss = list\r\n    }\r\n    else if (naluType === VVCNaluType.kPPS_NUT) {\r\n      ppss = list\r\n    }\r\n  }\r\n\r\n  return {\r\n    vpss,\r\n    spss,\r\n    ppss\r\n  }\r\n}\r\n\r\nexport function vpsSpsPps2Extradata(vpss: Uint8ArrayInterface[], spss: Uint8ArrayInterface[], ppss: Uint8ArrayInterface[]) {\r\n  \r\n  const sps = spss[0]\r\n  let ptl: Uint8Array\r\n  if (sps) {\r\n    const spsParams = parseSPS(sps)\r\n    let generalConstraintInfo = spsParams.generalConstraintInfo\r\n    if (!generalConstraintInfo.length) {\r\n      generalConstraintInfo = new Array(12).fill(0)\r\n    }\r\n    const biWriter = new BitWriter()\r\n    biWriter.writeU(9, 0)\r\n    biWriter.writeU(3, spsParams.spsMaxSublayersMinus1 + 1)\r\n    biWriter.writeU(2, 1)\r\n    biWriter.writeU(2, spsParams.chromaFormatIdc)\r\n    biWriter.writeU(3, spsParams.bitDepthMinus8)\r\n    biWriter.writeU(5, 0b11111)\r\n    biWriter.writeU(2, 0)\r\n    biWriter.writeU(6, generalConstraintInfo.length)\r\n    biWriter.writeU(7, spsParams.profile)\r\n    biWriter.writeU1(spsParams.tierFlag)\r\n    biWriter.writeU(8, spsParams.level)\r\n    biWriter.writeU1(spsParams.ptlFrameOnlyConstraintFlag)\r\n    biWriter.writeU1(spsParams.ptlMultilayerEnabledFlag)\r\n\r\n    if (generalConstraintInfo.length) {\r\n      for (let i = 0; i < generalConstraintInfo.length - 1; i++) {\r\n        biWriter.writeU(8, generalConstraintInfo[i])\r\n      }\r\n      biWriter.writeU(6, generalConstraintInfo[generalConstraintInfo.length - 1])\r\n    }\r\n    else {\r\n      biWriter.writeU(6, 0b111111)\r\n    }\r\n\r\n    if (spsParams.spsMaxSublayersMinus1 + 1 > 1) {\r\n      let ptl_sublayer_level_present_flags = 0\r\n      for (let i = spsParams.spsMaxSublayersMinus1 - 1; i >= 0; i--) {\r\n        ptl_sublayer_level_present_flags = (ptl_sublayer_level_present_flags << 1 | spsParams.ptlSublayerLevelPresentFlag[i])\r\n      }\r\n      biWriter.writeU(spsParams.spsMaxSublayersMinus1, ptl_sublayer_level_present_flags)\r\n\r\n      for (let j = spsParams.spsMaxSublayersMinus1 + 1; j <= 8 && spsParams.spsMaxSublayersMinus1 > 0; ++j) {\r\n        biWriter.writeU1(0)\r\n      }\r\n      for (let i = spsParams.spsMaxSublayersMinus1 - 1; i >= 0; i--) {\r\n        if (spsParams.ptlSublayerLevelPresentFlag[i]) {\r\n          biWriter.writeU(8, spsParams.sublayerLevelIdc[i])\r\n        }\r\n      }\r\n    }\r\n    biWriter.writeU(8, spsParams.generalSubProfileIdc.length)\r\n    for (let i = 0; i < spsParams.generalSubProfileIdc.length; i++) {\r\n      biWriter.writeU(8, spsParams.sublayerLevelIdc[i])\r\n    }\r\n    biWriter.writeU(16, spsParams.width)\r\n    biWriter.writeU(16, spsParams.height)\r\n    biWriter.writeU(16, 0)\r\n    biWriter.padding()\r\n    ptl = biWriter.getBuffer().subarray(0, biWriter.getPointer())\r\n  }\r\n\r\n  let length = 2 + (ptl ? ptl.length : 0)\r\n\r\n  if (vpss.length) {\r\n    // type + count\r\n    length += 3\r\n    length = vpss.reduce((prev, value) => {\r\n      // length + data\r\n      return prev + 2 + value.length\r\n    }, length)\r\n  }\r\n\r\n  if (spss.length) {\r\n    // type + count\r\n    length += 3\r\n    length = spss.reduce((prev, value) => {\r\n      // length + data\r\n      return prev + 2 + value.length\r\n    }, length)\r\n  }\r\n\r\n  if (ppss.length) {\r\n    // type + count\r\n    length += 3\r\n    length = ppss.reduce((prev, value) => {\r\n      // length + data\r\n      return prev + 2 + value.length\r\n    }, length)\r\n  }\r\n\r\n  const buffer = new Uint8Array(length)\r\n  const bufferWriter = new BufferWriter(buffer, true)\r\n\r\n  bufferWriter.writeUint8(NALULengthSizeMinusOne << 1 | (ptl ? 1 : 0) | 0xf8)\r\n\r\n  if (ptl) {\r\n    bufferWriter.writeBuffer(ptl)\r\n  }\r\n\r\n  // numOfArrays\r\n  let numOfArrays = 0\r\n  if (vpss.length) {\r\n    numOfArrays++\r\n  }\r\n  if (spss.length) {\r\n    numOfArrays++\r\n  }\r\n  if (ppss.length) {\r\n    numOfArrays++\r\n  }\r\n  bufferWriter.writeUint8(numOfArrays)\r\n\r\n  // vps\r\n  if (vpss.length) {\r\n    bufferWriter.writeUint8((1 << 7) | VVCNaluType.kVPS_NUT)\r\n    bufferWriter.writeUint16(vpss.length)\r\n    array.each(vpss, (vps) => {\r\n      bufferWriter.writeUint16(vps.length)\r\n      bufferWriter.writeBuffer(vps)\r\n    })\r\n  }\r\n\r\n  // sps\r\n  if (spss.length) {\r\n    bufferWriter.writeUint8((1 << 7) | VVCNaluType.kSPS_NUT)\r\n    bufferWriter.writeUint16(spss.length)\r\n    array.each(spss, (sps) => {\r\n      bufferWriter.writeUint16(sps.length)\r\n      bufferWriter.writeBuffer(sps)\r\n    })\r\n  }\r\n\r\n  // pps\r\n  if (ppss.length) {\r\n    bufferWriter.writeUint8((1 << 7) | VVCNaluType.kPPS_NUT)\r\n    bufferWriter.writeUint16(ppss.length)\r\n    array.each(ppss, (pps) => {\r\n      bufferWriter.writeUint16(pps.length)\r\n      bufferWriter.writeBuffer(pps)\r\n    })\r\n  }\r\n\r\n  return buffer\r\n}\r\n\r\nexport function annexbExtradata2AvccExtradata(data: Uint8ArrayInterface) {\r\n  let nalus = splitNaluByStartCode(data)\r\n\r\n  if (nalus.length >= 2) {\r\n    const vpss = []\r\n    const spss = []\r\n    const ppss = []\r\n\r\n    nalus.forEach((nalu) => {\r\n      const type = (nalu[1] >>> 3) & 0x1f\r\n      if (type === VVCNaluType.kVPS_NUT) {\r\n        vpss.push(nalu)\r\n      }\r\n      else if (type === VVCNaluType.kSPS_NUT) {\r\n        spss.push(nalu)\r\n      }\r\n      else if (type === VVCNaluType.kPPS_NUT) {\r\n        ppss.push(nalu)\r\n      }\r\n    })\r\n\r\n    if (spss.length && ppss.length) {\r\n      return vpsSpsPps2Extradata(vpss, spss, ppss)\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * \r\n * annexb  NALU  avcc NALU \r\n * \r\n */\r\nexport function annexb2Avcc(data: Uint8ArrayInterface) {\r\n  let extradata: Uint8Array\r\n  let key: boolean = false\r\n\r\n  let nalus = splitNaluByStartCode(data)\r\n\r\n  if (nalus.length >= 2) {\r\n    const vpss = []\r\n    const spss = []\r\n    const ppss = []\r\n\r\n    nalus.forEach((nalu) => {\r\n      const type = (nalu[1] >>> 3) & 0x1f\r\n      if (type === VVCNaluType.kVPS_NUT) {\r\n        vpss.push(nalu)\r\n      }\r\n      else if (type === VVCNaluType.kSPS_NUT) {\r\n        spss.push(nalu)\r\n      }\r\n      else if (type === VVCNaluType.kPPS_NUT) {\r\n        ppss.push(nalu)\r\n      }\r\n    })\r\n\r\n    if (spss.length && ppss.length) {\r\n      extradata = vpsSpsPps2Extradata(vpss, spss, ppss)\r\n\r\n      nalus = nalus.filter((nalu) => {\r\n        const type = (nalu[1] >>> 3) & 0x1f\r\n        return type !== VVCNaluType.kVPS_NUT\r\n          && type !== VVCNaluType.kSPS_NUT\r\n          && type !== VVCNaluType.kPPS_NUT\r\n          && type !== VVCNaluType.kAUD_NUT\r\n      })\r\n    }\r\n  }\r\n\r\n  const length = nalus.reduce((prev, nalu) => {\r\n    return prev + NALULengthSizeMinusOne + 1 + nalu.length\r\n  }, 0)\r\n\r\n  const bufferPointer = avMalloc(length)\r\n  const buffer = mapUint8Array(bufferPointer, length)\r\n\r\n  const bufferWriter = new BufferWriter(buffer)\r\n\r\n  array.each(nalus, (nalu) => {\r\n    if (NALULengthSizeMinusOne === 3) {\r\n      bufferWriter.writeUint32(nalu.length)\r\n    }\r\n    else if (NALULengthSizeMinusOne === 2) {\r\n      bufferWriter.writeUint24(nalu.length)\r\n    }\r\n    else if (NALULengthSizeMinusOne === 1) {\r\n      bufferWriter.writeUint16(nalu.length)\r\n    }\r\n    else {\r\n      bufferWriter.writeUint8(nalu.length)\r\n    }\r\n    bufferWriter.writeBuffer(nalu.subarray(0))\r\n\r\n    const type = (nalu[1] >>> 3) & 0x1f\r\n    if (type === VVCNaluType.kIDR_N_LP\r\n      || type === VVCNaluType.kIDR_W_RADL\r\n      || type === VVCNaluType.kCRA_NUT\r\n      || type === VVCNaluType.kGDR_NUT\r\n    ) {\r\n      key = true\r\n    }\r\n  })\r\n\r\n  return {\r\n    bufferPointer,\r\n    length,\r\n    extradata,\r\n    key\r\n  }\r\n}\r\n\r\n/**\r\n * avcc  NALU  annexb NALU \r\n * \r\n */\r\nexport function avcc2Annexb(data: Uint8ArrayInterface, extradata?: Uint8ArrayInterface) {\r\n  const naluLengthSizeMinusOne = extradata ? ((extradata[0] >>> 1) & 0x03) : NALULengthSizeMinusOne\r\n\r\n  let vpss = []\r\n  let spss = []\r\n  let ppss = []\r\n  let key = false\r\n\r\n  if (extradata) {\r\n    const result = extradata2VpsSpsPps(extradata)\r\n    vpss = result.vpss\r\n    spss = result.spss\r\n    ppss = result.ppss\r\n    key = true\r\n  }\r\n\r\n  const nalus = []\r\n\r\n  const bufferReader = new BufferReader(data)\r\n  while (bufferReader.remainingSize() > 0) {\r\n    let length = 0\r\n    if (naluLengthSizeMinusOne === 3) {\r\n      length = bufferReader.readUint32()\r\n    }\r\n    else if (naluLengthSizeMinusOne === 2) {\r\n      length = bufferReader.readUint24()\r\n    }\r\n    else if (naluLengthSizeMinusOne === 1) {\r\n      length = bufferReader.readUint16()\r\n    }\r\n    else {\r\n      length = bufferReader.readUint8()\r\n    }\r\n    nalus.push(bufferReader.readBuffer(length))\r\n  }\r\n\r\n  let length = vpss.reduce((prev, vps) => {\r\n    return prev + 4 + vps.length\r\n  }, 0)\r\n  length = spss.reduce((prev, sps) => {\r\n    return prev + 4 + sps.length\r\n  }, length)\r\n  length = ppss.reduce((prev, pps) => {\r\n    return prev + 4 + pps.length\r\n  }, length)\r\n  length = nalus.reduce((prev, nalu, index) => {\r\n    return prev + (index ? 3 : 4) + nalu.length\r\n  }, length)\r\n\r\n  const bufferPointer = avMalloc(length + 7)\r\n  const buffer = mapUint8Array(bufferPointer, length + 7)\r\n\r\n  const bufferWriter = new BufferWriter(buffer)\r\n\r\n  // AUD\r\n  bufferWriter.writeUint8(0x00)\r\n  bufferWriter.writeUint8(0x00)\r\n  bufferWriter.writeUint8(0x00)\r\n  bufferWriter.writeUint8(0x01)\r\n  bufferWriter.writeUint8(0x00)\r\n  bufferWriter.writeUint8(VVCNaluType.kAUD_NUT << 3)\r\n  bufferWriter.writeUint8(0xf0)\r\n\r\n  array.each(vpss, (vps) => {\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x01)\r\n    bufferWriter.writeBuffer(vps)\r\n  })\r\n\r\n  array.each(spss, (sps) => {\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x01)\r\n    bufferWriter.writeBuffer(sps)\r\n  })\r\n\r\n  array.each(ppss, (pps) => {\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x01)\r\n    bufferWriter.writeBuffer(pps)\r\n  })\r\n\r\n  array.each(nalus, (nalu, index) => {\r\n    bufferWriter.writeUint8(0x00)\r\n    bufferWriter.writeUint8(0x00)\r\n    if (!index) {\r\n      bufferWriter.writeUint8(0x00)\r\n    }\r\n    bufferWriter.writeUint8(0x01)\r\n    bufferWriter.writeBuffer(nalu)\r\n\r\n    const type = (nalu[1] >>> 3) & 0x1f\r\n    if (type === VVCNaluType.kIDR_N_LP\r\n      || type === VVCNaluType.kIDR_W_RADL\r\n      || type === VVCNaluType.kCRA_NUT\r\n      || type === VVCNaluType.kGDR_NUT\r\n    ) {\r\n      key = true\r\n    }\r\n  })\r\n\r\n  return {\r\n    bufferPointer,\r\n    length: length + 7,\r\n    key\r\n  }\r\n}\r\n\r\nexport function parseAvccExtraData(avpacket: pointer<AVPacket>, stream: AVStream) {\r\n  if (!(avpacket.flags & AVPacketFlags.AV_PKT_FLAG_KEY)) {\r\n    return\r\n  }\r\n\r\n  const data = getAVPacketData(avpacket)\r\n\r\n  if (isAnnexb(data)) {\r\n    return\r\n  }\r\n\r\n  const naluLengthSizeMinusOne = stream.metadata.naluLengthSizeMinusOne ?? NALULengthSizeMinusOne\r\n\r\n  let vpss = []\r\n  let spss = []\r\n  let ppss = []\r\n\r\n  const bufferReader = new BufferReader(data)\r\n  while (bufferReader.remainingSize() > 0) {\r\n    let length = 0\r\n    if (naluLengthSizeMinusOne === 3) {\r\n      length = bufferReader.readUint32()\r\n    }\r\n    else if (naluLengthSizeMinusOne === 2) {\r\n      length = bufferReader.readUint24()\r\n    }\r\n    else if (naluLengthSizeMinusOne === 1) {\r\n      length = bufferReader.readUint16()\r\n    }\r\n    else {\r\n      length = bufferReader.readUint8()\r\n    }\r\n\r\n    const nalu = data.subarray(static_cast<int32>(bufferReader.getPos()), static_cast<int32>(bufferReader.getPos()) + length)\r\n    bufferReader.skip(length)\r\n\r\n    const naluType = (nalu[1] >>> 3) & 0x1f\r\n\r\n    if (naluType === VVCNaluType.kSPS_NUT) {\r\n      spss.push(nalu)\r\n    }\r\n    else if (naluType === VVCNaluType.kPPS_NUT) {\r\n      ppss.push(nalu)\r\n    }\r\n    else if (naluType === VVCNaluType.kVPS_NUT) {\r\n      vpss.push(nalu)\r\n    }\r\n  }\r\n\r\n  if (spss.length || ppss.length || vpss.length) {\r\n    const extradata = vpsSpsPps2Extradata(vpss, spss, ppss)\r\n    const extradataPointer = avMalloc(extradata.length)\r\n    memcpyFromUint8Array(extradataPointer, extradata.length, extradata)\r\n    addAVPacketSideData(avpacket, AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA, extradataPointer, extradata.length)\r\n  }\r\n}\r\n\r\nexport function parseAnnexbExtraData(avpacket: pointer<AVPacket>, force: boolean = false) {\r\n  if (!(avpacket.flags & AVPacketFlags.AV_PKT_FLAG_KEY) && !force) {\r\n    return\r\n  }\r\n\r\n  const data = getAVPacketData(avpacket)\r\n\r\n  if (!isAnnexb(data)) {\r\n    return\r\n  }\r\n\r\n  let nalus = splitNaluByStartCode(data)\r\n\r\n  if (nalus.length > 2) {\r\n    const vpss = []\r\n    const spss = []\r\n    const ppss = []\r\n\r\n    nalus.forEach((nalu) => {\r\n      const type = (nalu[1] >>> 3) & 0x1f\r\n      if (type === VVCNaluType.kVPS_NUT) {\r\n        vpss.push(nalu)\r\n      }\r\n      else if (type === VVCNaluType.kSPS_NUT) {\r\n        spss.push(nalu)\r\n      }\r\n      else if (type === VVCNaluType.kPPS_NUT) {\r\n        ppss.push(nalu)\r\n      }\r\n    })\r\n\r\n    if (vpss.length && spss.length && ppss.length) {\r\n      const extradata = vpsSpsPps2Extradata(vpss, spss, ppss)\r\n      const extradataPointer = avMalloc(extradata.length)\r\n      memcpyFromUint8Array(extradataPointer, extradata.length, extradata)\r\n      addAVPacketSideData(avpacket, AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA, extradataPointer, extradata.length)\r\n      avpacket.flags |= AVPacketFlags.AV_PKT_FLAG_KEY\r\n    }\r\n  }\r\n}\r\n\r\nexport function parseAVCodecParametersBySps(stream: AVStream, sps: Uint8Array) {\r\n  const { profile, level, width, height } = parseSPS(sps)\r\n  stream.codecpar.profile = profile\r\n  stream.codecpar.level = level\r\n  stream.codecpar.width = width\r\n  stream.codecpar.height = height\r\n}\r\n\r\nexport function parseAVCodecParameters(stream: AVStream, extradata?: Uint8ArrayInterface) {\r\n  if (!extradata && stream.sideData[AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA]) {\r\n    extradata = stream.sideData[AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA]\r\n  }\r\n  if (extradata && extradata.length >= 6) {\r\n\r\n    stream.metadata.naluLengthSizeMinusOne = (extradata[0] >>> 1) & 0x03\r\n\r\n    const { spss } = extradata2VpsSpsPps(extradata)\r\n\r\n    if (spss.length) {\r\n      parseAVCodecParametersBySps(stream, spss[0])\r\n    }\r\n  }\r\n}\r\n\r\nexport function isIDR(avpacket: pointer<AVPacket>, naluLengthSize: int32 = 4) {\r\n  if (!(avpacket.flags & AVPacketFlags.AV_PKT_FLAG_KEY)) {\r\n    return false\r\n  }\r\n  if (avpacket.bitFormat === BitFormat.ANNEXB) {\r\n    let nalus = splitNaluByStartCode(mapUint8Array(avpacket.data, avpacket.size))\r\n    return nalus.some((nalu) => {\r\n      const type = (nalu[1] >>> 3) & 0x1f\r\n      return type === VVCNaluType.kIDR_N_LP || type === VVCNaluType.kIDR_W_RADL\r\n    })\r\n  }\r\n  else {\r\n    const size = avpacket.size\r\n    let i = 0\r\n    while (i < (size - naluLengthSize)) {\r\n      const type = (intread.r8(avpacket.data + (i + naluLengthSize + 1)) >>> 3) & 0x1f\r\n      if (type === VVCNaluType.kIDR_N_LP || type === VVCNaluType.kIDR_W_RADL) {\r\n        return true\r\n      }\r\n      if (naluLengthSize === 4) {\r\n        i += intread.rb32(avpacket.data + i)\r\n      }\r\n      else if (naluLengthSize === 3) {\r\n        i += intread.rb24(avpacket.data + i)\r\n      }\r\n      else if (naluLengthSize === 2) {\r\n        i += intread.rb16(avpacket.data + i)\r\n      }\r\n      else {\r\n        i += intread.r8(avpacket.data + i)\r\n      }\r\n      i += naluLengthSize\r\n    }\r\n    return false\r\n  }\r\n}\r\n\r\nexport interface VvcSPS {\r\n  profile: number\r\n  level: number\r\n  width: number\r\n  height: number\r\n  chromaFormatIdc: number\r\n  bitDepthMinus8: number\r\n  generalProfileSpace: number\r\n  tierFlag: number\r\n  generalConstraintInfo: number[]\r\n  generalSubProfileIdc: number[]\r\n  ptlFrameOnlyConstraintFlag: number\r\n  ptlMultilayerEnabledFlag: number\r\n  spsMaxSublayersMinus1: number\r\n  ptlSublayerLevelPresentFlag: number[]\r\n  sublayerLevelIdc: number[]\r\n  sps_log2_max_pic_order_cnt_lsb_minus4: number\r\n  sps_poc_msb_cycle_flag: number\r\n  sps_poc_msb_cycle_len_minus1: number\r\n  sps_num_extra_ph_bytes: number\r\n    sps_extra_ph_bit_present_flag: number[]\r\n}\r\n\r\nexport function parseSPS(sps: Uint8ArrayInterface): VvcSPS {\r\n  if (!sps || sps.length < 3) {\r\n    return\r\n  }\r\n\r\n  let offset = 0\r\n  if (sps[0] === 0x00\r\n    && sps[1] === 0x00\r\n    && sps[2] === 0x00\r\n    && sps[3] === 0x01\r\n  ) {\r\n    offset = 4\r\n  }\r\n\r\n  let profile = 0\r\n  let level = 0\r\n  let width = 0\r\n  let height = 0\r\n  let bitDepthMinus8 = 0\r\n  let chromaFormatIdc = 1\r\n  let generalProfileSpace = 0\r\n  let tierFlag = 0\r\n  let ptlFrameOnlyConstraintFlag = 0\r\n  let ptlMultilayerEnabledFlag = 0\r\n\r\n  const generalConstraintInfo = []\r\n  const ptlSublayerLevelPresentFlag = []\r\n  const sublayerLevelIdc = []\r\n  const generalSubProfileIdc = []\r\n\r\n  const buffer = naluUnescape(sps.subarray(offset))\r\n  const bitReader = new BitReader(buffer.length)\r\n  bitReader.appendBuffer(buffer)\r\n\r\n  // forbidden_zero_bit\r\n  bitReader.readU1()\r\n  // nuh_reserved_zero_bit\r\n  bitReader.readU1()\r\n  // layerId\r\n  bitReader.readU(6)\r\n  // nalu type\r\n  bitReader.readU(5)\r\n  // tid\r\n  bitReader.readU(3)\r\n\r\n  // sps_seq_parameter_set_id && sps_video_parameter_set_id\r\n  bitReader.readU(8)\r\n\r\n  const spsMaxSublayersMinus1 = bitReader.readU(3)\r\n  chromaFormatIdc = bitReader.readU(2)\r\n  const sps_log2_ctu_size_minus5 = bitReader.readU(2)\r\n  const sps_ptl_dpb_hrd_params_present_flag = bitReader.readU(1)\r\n  if (sps_ptl_dpb_hrd_params_present_flag) {\r\n    profile = bitReader.readU(7)\r\n    tierFlag = bitReader.readU(1)\r\n    level = bitReader.readU(8)\r\n    ptlFrameOnlyConstraintFlag = bitReader.readU(1)\r\n    ptlMultilayerEnabledFlag = bitReader.readU(1)\r\n    const gci_present_flag = bitReader.readU(1)\r\n    if (gci_present_flag) {\r\n      for (let j = 0; j < 8; j++) {\r\n        generalConstraintInfo[j] = bitReader.readU(8)\r\n      }\r\n      generalConstraintInfo[8] = bitReader.readU(7)\r\n      const gci_num_reserved_bits = bitReader.readU(8)\r\n      bitReader.readU(gci_num_reserved_bits)\r\n    }\r\n    bitReader.skipPadding()\r\n    for (let i = spsMaxSublayersMinus1 - 1; i >= 0; i--) {\r\n      ptlSublayerLevelPresentFlag[i] = bitReader.readU(1)\r\n    }\r\n    bitReader.skipPadding()\r\n    for (let i = spsMaxSublayersMinus1 - 1; i >= 0; i--) {\r\n      if (ptlSublayerLevelPresentFlag[i]) {\r\n        sublayerLevelIdc[i] = bitReader.readU(8)\r\n      }\r\n    }\r\n\r\n    const ptl_num_sub_profiles = bitReader.readU(8)\r\n    if (ptl_num_sub_profiles) {\r\n      for (let i = 0; i < ptl_num_sub_profiles; i++) {\r\n        generalSubProfileIdc[i] = bitReader.readU(32)\r\n      }\r\n    } \r\n  }\r\n\r\n  // sps_gdr_enabled_flag\r\n  bitReader.readU1()\r\n  const sps_ref_pic_resampling_enabled_flag = bitReader.readU1()\r\n  if (sps_ref_pic_resampling_enabled_flag) {\r\n    // sps_res_change_in_clvs_allowed_flag\r\n    bitReader.readU1()\r\n  }\r\n\r\n  const sps_pic_width_max_in_luma_samples = width = expgolomb.readUE(bitReader)\r\n  const sps_pic_height_max_in_luma_samples = height = expgolomb.readUE(bitReader)\r\n\r\n  if (bitReader.readU1()) {\r\n    // sps_conf_win_left_offset\r\n    expgolomb.readUE(bitReader)\r\n    // sps_conf_win_right_offset\r\n    expgolomb.readUE(bitReader)\r\n    // sps_conf_win_top_offset\r\n    expgolomb.readUE(bitReader)\r\n    // sps_conf_win_bottom_offset\r\n    expgolomb.readUE(bitReader)\r\n  }\r\n\r\n  if (bitReader.readU1()) {\r\n    const sps_num_subpics_minus1 = expgolomb.readUE(bitReader)\r\n    const ctb_log2_size_y = sps_log2_ctu_size_minus5 + 5\r\n    const ctb_size_y      = 1 << ctb_log2_size_y\r\n    const tmp_width_val   = sps_pic_width_max_in_luma_samples / (1 << ctb_log2_size_y)\r\n    const tmp_height_val  = sps_pic_height_max_in_luma_samples / (1 << ctb_log2_size_y)\r\n    const wlen            = Math.ceil(Math.log2(tmp_width_val))\r\n    const hlen            = Math.ceil(Math.log2(tmp_height_val))\r\n\r\n    let sps_subpic_id_len = 0\r\n    let sps_subpic_same_size_flag = 0\r\n    let sps_independent_subpics_flag = 0\r\n     // sps_num_subpics_minus1\r\n    if (sps_num_subpics_minus1 > 0) {\r\n      sps_independent_subpics_flag = bitReader.readU1()\r\n      sps_subpic_same_size_flag = bitReader.readU1()\r\n    }\r\n    for (let i = 0; sps_num_subpics_minus1 > 0 && i <= sps_num_subpics_minus1; i++) {\r\n      if (!sps_subpic_same_size_flag || i == 0) {\r\n        if (i > 0 && sps_pic_width_max_in_luma_samples > ctb_size_y) {\r\n          bitReader.readU(wlen)\r\n        }\r\n        if (i > 0 && sps_pic_height_max_in_luma_samples > ctb_size_y) {\r\n          bitReader.readU(hlen)\r\n        }\r\n        if (i < sps_num_subpics_minus1 && sps_pic_width_max_in_luma_samples > ctb_size_y) {\r\n          bitReader.readU(wlen)\r\n        }\r\n        if (i < sps_num_subpics_minus1 && sps_pic_height_max_in_luma_samples > ctb_size_y) {\r\n          bitReader.readU(hlen)\r\n        }\r\n      }\r\n      if (!sps_independent_subpics_flag) {\r\n        // sps_subpic_treated_as_pic_flag && sps_loop_filter_across_subpic_enabled_flag\r\n        bitReader.readU(2)\r\n      }\r\n    }\r\n    sps_subpic_id_len = expgolomb.readUE(bitReader) + 1\r\n    // sps_subpic_id_mapping_explicitly_signalled_flag\r\n    if (bitReader.readU(1)) {\r\n       // sps_subpic_id_mapping_present_flag\r\n      if (bitReader.readU(1)) {\r\n        for (let i = 0; i <= sps_num_subpics_minus1; i++) {\r\n          // sps_subpic_id[i]\r\n          bitReader.readU(sps_subpic_id_len)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  bitDepthMinus8 = expgolomb.readUE(bitReader)\r\n\r\n  // sps_entropy_coding_sync_enabled_flag\r\n  bitReader.readU(1)\r\n  // sps_entry_point_offsets_present_flag\r\n  bitReader.readU(1)\r\n\r\n  const sps_log2_max_pic_order_cnt_lsb_minus4 = bitReader.readU(4)\r\n  const sps_poc_msb_cycle_flag = bitReader.readU(1)\r\n  let sps_poc_msb_cycle_len_minus1 = 0\r\n  if (sps_poc_msb_cycle_flag) {\r\n    sps_poc_msb_cycle_len_minus1 = expgolomb.readUE(bitReader)\r\n  }\r\n  const sps_extra_ph_bit_present_flag: number[] = []\r\n  const sps_num_extra_ph_bytes = bitReader.readU(2)\r\n  for (let i = 0; i < (sps_num_extra_ph_bytes * 8); i++) {\r\n    sps_extra_ph_bit_present_flag[i] = bitReader.readU(1)\r\n  }\r\n\r\n  return {\r\n    profile,\r\n    level,\r\n    width,\r\n    height,\r\n    chromaFormatIdc,\r\n    bitDepthMinus8,\r\n    generalProfileSpace,\r\n    tierFlag,\r\n    generalConstraintInfo,\r\n    generalSubProfileIdc,\r\n    ptlFrameOnlyConstraintFlag,\r\n    ptlMultilayerEnabledFlag,\r\n    spsMaxSublayersMinus1,\r\n    ptlSublayerLevelPresentFlag,\r\n    sublayerLevelIdc,\r\n    sps_log2_max_pic_order_cnt_lsb_minus4,\r\n    sps_poc_msb_cycle_flag,\r\n    sps_poc_msb_cycle_len_minus1,\r\n    sps_num_extra_ph_bytes,\r\n    sps_extra_ph_bit_present_flag\r\n  }\r\n}\r\n\r\nexport function parseExtraData(extradata: Uint8ArrayInterface) {\r\n\r\n  if (extradata[0] === 0 && extradata[1] === 0 && extradata[2] === 0 && extradata[3] === 1) {\r\n    extradata = annexbExtradata2AvccExtradata(extradata)\r\n  }\r\n\r\n  const bitReader = new BitReader()\r\n  bitReader.appendBuffer(extradata)\r\n  const ptlPresentFlag = bitReader.readU(8) & 0x01\r\n  if (ptlPresentFlag) {\r\n    return parsePTL(bitReader)\r\n  }\r\n  return {} as Data\r\n}","/*\r\n * libmedia mpegts encoder\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport { AVOFormatContext } from '../AVFormatContext'\r\nimport AVPacket, { AVPacketFlags } from 'avutil/struct/avpacket'\r\nimport createMpegtsContext from './mpegts/function/createMpegtsContext'\r\nimport { PAT, PES, PMT, SectionPacket, TSPacket } from './mpegts/struct'\r\nimport { MpegtsContext, MpegtsStreamContext } from './mpegts/type'\r\nimport OFormat from './OFormat'\r\nimport * as mpegts from './mpegts/mpegts'\r\nimport * as ompegts from './mpegts/ompegts'\r\nimport * as array from 'common/util/array'\r\nimport * as object from 'common/util/object'\r\nimport { AVCodecID, AVMediaType, AVPacketSideDataType } from 'avutil/codec'\r\nimport createMpegtsStreamContext from './mpegts/function/createMpegtsStreamContext'\r\nimport AVBSFilter from '../bsf/AVBSFilter'\r\nimport AACRaw2ADTSFilter from '../bsf/aac/Raw2ADTSFilter'\r\nimport AACRaw2LATMFilter from '../bsf/aac/Raw2LATMFilter'\r\nimport OpusRaw2MpegtsFilter from '../bsf/opus/Raw2MpegtsFilter'\r\nimport Avcc2AnnexbFilter from '../bsf/h2645/Avcc2AnnexbFilter'\r\nimport { AV_TIME_BASE, AV_TIME_BASE_Q, NOPTS_VALUE_BIGINT } from 'avutil/constant'\r\nimport { AVFormat } from '../avformat'\r\nimport { memcpy } from 'cheap/std/memory'\r\nimport { avRescaleQ } from 'avutil/util/rational'\r\nimport { addAVPacketSideData, getAVPacketData, hasAVPacketSideData } from 'avutil/util/avpacket'\r\nimport { avMalloc } from 'avutil/util/mem'\r\nimport * as logger from 'common/util/logger'\r\n\r\nexport interface OMpegtsFormatOptions {\r\n  pesMaxSize?: number\r\n  delay?: number\r\n  latm?: boolean\r\n  patPeriod?: number\r\n}\r\n\r\nconst defaultOMpegtsFormatOptions = {\r\n  pesMaxSize: (16 - 1) * 184 + 170,\r\n  delay: 1.4,\r\n  latm: false,\r\n  patPeriod: 0.1\r\n}\r\n\r\nexport default class OMpegtsFormat extends OFormat {\r\n\r\n  public type: AVFormat = AVFormat.MPEGTS\r\n\r\n  private context: MpegtsContext\r\n\r\n  private sdtPacket: SectionPacket\r\n\r\n  private patPacket: SectionPacket\r\n\r\n  private pmtPacket: SectionPacket\r\n\r\n  private options: OMpegtsFormatOptions\r\n\r\n  private firstDtsCheck: boolean\r\n\r\n  private firstVideoCheck: boolean\r\n\r\n  private lastPatDst: bigint\r\n\r\n  private patPeriod: bigint\r\n\r\n  constructor(options: OMpegtsFormatOptions = {}) {\r\n    super()\r\n    this.context = createMpegtsContext()\r\n    this.options = object.extend({}, defaultOMpegtsFormatOptions, options)\r\n\r\n    this.options.pesMaxSize = this.options.pesMaxSize ? (this.options.pesMaxSize + 14 + 183) / 184 * 184 - 14 : 0\r\n    this.firstDtsCheck = false\r\n    this.firstVideoCheck = false\r\n\r\n    this.patPeriod = static_cast<int64>(this.options.patPeriod * AV_TIME_BASE)\r\n  }\r\n\r\n  public init(context: AVOFormatContext): number {\r\n    context.ioWriter.setEndian(true)\r\n    return 0\r\n  }\r\n\r\n  public destroy(context: AVOFormatContext): void {\r\n    super.destroy(context)\r\n    array.each(context.streams, (stream) => {\r\n      const streamContext = stream.privData as MpegtsStreamContext\r\n      if (streamContext.filter) {\r\n        streamContext.filter.destroy()\r\n        streamContext.filter = null\r\n      }\r\n    })\r\n  }\r\n\r\n  public writeHeader(context: AVOFormatContext): number {\r\n\r\n    this.context.pat = new PAT()\r\n    this.context.pat.program2PmtPid.set(1, 4096)\r\n\r\n    this.context.pmt = new PMT()\r\n    this.context.pmt.programNumber = 1\r\n\r\n    array.each(context.streams, (stream) => {\r\n\r\n      stream.timeBase.den = 90000\r\n      stream.timeBase.num = 1\r\n\r\n      const pid = this.context.startPid++\r\n\r\n      if (this.context.pmt.pcrPid <= 0) {\r\n        this.context.pmt.pcrPid = pid\r\n      }\r\n\r\n      let streamType = ompegts.getStreamType(stream)\r\n\r\n      const streamContext = createMpegtsStreamContext()\r\n\r\n      stream.privData = streamContext\r\n\r\n      const tsPacket = new TSPacket()\r\n      tsPacket.pid = pid\r\n      tsPacket.adaptationFieldControl = 0x01\r\n\r\n      streamContext.tsPacket = tsPacket\r\n      streamContext.pid = pid\r\n\r\n      let filter: AVBSFilter = null\r\n\r\n      switch (streamType) {\r\n        case mpegts.TSStreamType.AUDIO_AAC:\r\n          if (this.options.latm) {\r\n            streamContext.latm = true\r\n            streamType = mpegts.TSStreamType.AUDIO_AAC_LATM\r\n            filter = new AACRaw2LATMFilter()\r\n          }\r\n          else {\r\n            filter = new AACRaw2ADTSFilter()\r\n          }\r\n\r\n          break\r\n        case mpegts.TSStreamType.VIDEO_H264:\r\n        case mpegts.TSStreamType.VIDEO_HEVC:\r\n          filter = new Avcc2AnnexbFilter()\r\n          break\r\n        case mpegts.TSStreamType.PRIVATE_DATA:\r\n          if (stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_OPUS) {\r\n            filter = new OpusRaw2MpegtsFilter()\r\n          }\r\n          break\r\n      }\r\n\r\n      if (filter) {\r\n        filter.init(addressof(stream.codecpar), addressof(stream.timeBase))\r\n      }\r\n\r\n      streamContext.filter = filter\r\n      this.context.pmt.pid2StreamType.set(pid, streamType)\r\n\r\n      const pes = new PES()\r\n      pes.pid = pid\r\n      pes.streamType = streamType\r\n      pes.streamId = ompegts.getStreamId(stream)\r\n      streamContext.pes = pes\r\n    })\r\n\r\n    this.patPacket = new SectionPacket()\r\n    this.pmtPacket = new SectionPacket()\r\n    this.sdtPacket = new SectionPacket()\r\n\r\n    this.sdtPacket.pid = mpegts.TSPid.SDT\r\n    this.sdtPacket.adaptationFieldControl = 0x01\r\n    this.patPacket.pid = mpegts.TSPid.PAT\r\n    this.patPacket.adaptationFieldControl = 0x01\r\n    this.pmtPacket.pid = 4096\r\n    this.pmtPacket.adaptationFieldControl = 0x01\r\n\r\n    this.sdtPacket.payload = ompegts.getSDTPayload()\r\n    this.patPacket.payload = ompegts.getPATPayload(this.context.pat)\r\n    this.pmtPacket.payload = ompegts.getPMTPayload(this.context.pmt, context.streams)\r\n\r\n    ompegts.writeSection(context.ioWriter, this.sdtPacket, this.context)\r\n    ompegts.writeSection(context.ioWriter, this.patPacket, this.context)\r\n    ompegts.writeSection(context.ioWriter, this.pmtPacket, this.context)\r\n\r\n    return 0\r\n  }\r\n\r\n  public writeAVPacket(formatContext: AVOFormatContext, avpacket: pointer<AVPacket>): number {\r\n\r\n    if (!avpacket.size) {\r\n      logger.warn(`packet\\'s size is 0: ${avpacket.streamIndex}, ignore it`)\r\n      return\r\n    }\r\n\r\n    const stream = formatContext.getStreamByIndex(avpacket.streamIndex)\r\n\r\n    if (!stream) {\r\n      logger.warn(`can not found the stream width the packet\\'s streamIndex: ${avpacket.streamIndex}, ignore it`)\r\n      return\r\n    }\r\n\r\n    if (!this.firstDtsCheck) {\r\n      if (avRescaleQ(avpacket.dts, avpacket.timeBase, stream.timeBase)\r\n        < static_cast<int64>(this.options.delay * 90000)\r\n      ) {\r\n        this.context.delay = static_cast<int64>(this.options.delay * 90000)\r\n        - avRescaleQ(avpacket.dts, avpacket.timeBase, stream.timeBase)\r\n      }\r\n      this.firstDtsCheck = true\r\n      this.lastPatDst = avRescaleQ(avpacket.dts, avpacket.timeBase, AV_TIME_BASE_Q)\r\n    }\r\n\r\n    if (this.patPeriod > 0n\r\n      && avRescaleQ(avpacket.dts, avpacket.timeBase, AV_TIME_BASE_Q) - this.lastPatDst > this.patPeriod\r\n    ) {\r\n      ompegts.writeSection(formatContext.ioWriter, this.sdtPacket, this.context)\r\n      ompegts.writeSection(formatContext.ioWriter, this.patPacket, this.context)\r\n      ompegts.writeSection(formatContext.ioWriter, this.pmtPacket, this.context)\r\n      this.lastPatDst = avRescaleQ(avpacket.dts, avpacket.timeBase, AV_TIME_BASE_Q)\r\n    }\r\n\r\n    const streamContext = stream.privData as MpegtsStreamContext\r\n\r\n    let buffer = getAVPacketData(avpacket)\r\n\r\n    if (streamContext.filter) {\r\n      if (!this.firstVideoCheck\r\n        && !hasAVPacketSideData(avpacket, AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA)\r\n        && stream.codecpar.extradata\r\n        && (\r\n          stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_H264\r\n            || stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_HEVC\r\n            || stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_VVC\r\n            || stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_MPEG4\r\n        )\r\n      ) {\r\n        this.firstVideoCheck = true\r\n        const extradata = avMalloc(stream.codecpar.extradataSize)\r\n        memcpy(extradata, stream.codecpar.extradata, stream.codecpar.extradataSize)\r\n        addAVPacketSideData(avpacket, AVPacketSideDataType.AV_PKT_DATA_NEW_EXTRADATA, extradata, stream.codecpar.extradataSize)\r\n      }\r\n      streamContext.filter.sendAVPacket(avpacket)\r\n      streamContext.filter.receiveAVPacket(avpacket)\r\n      buffer = getAVPacketData(avpacket)\r\n    }\r\n\r\n    if (!buffer.length) {\r\n      return 0\r\n    }\r\n\r\n    buffer = buffer.slice()\r\n\r\n    let currentWrote = false\r\n\r\n    if (streamContext.pesSlices.total + buffer.length > this.options.pesMaxSize\r\n      || stream.codecpar.codecType === AVMediaType.AVMEDIA_TYPE_VIDEO\r\n    ) {\r\n      if (streamContext.pesSlices.total === 0) {\r\n        streamContext.pesSlices.total = buffer.length\r\n        streamContext.pesSlices.buffers.push(buffer)\r\n        if (avpacket.dts !== NOPTS_VALUE_BIGINT) {\r\n          streamContext.pes.dts = avRescaleQ(avpacket.dts, avpacket.timeBase, stream.timeBase) + this.context.delay\r\n        }\r\n        if (avpacket.pts !== NOPTS_VALUE_BIGINT) {\r\n          streamContext.pes.pts = avRescaleQ(avpacket.pts, avpacket.timeBase, stream.timeBase) + this.context.delay\r\n        }\r\n        currentWrote = true\r\n      }\r\n\r\n      if (avpacket.flags & AVPacketFlags.AV_PKT_FLAG_KEY) {\r\n        streamContext.pes.randomAccessIndicator = 1\r\n      }\r\n\r\n      ompegts.writePES(formatContext.ioWriter, streamContext.pes, streamContext.pesSlices, stream, this.context)\r\n\r\n      streamContext.pesSlices.total = 0\r\n      streamContext.pesSlices.buffers = []\r\n    }\r\n\r\n    if (!currentWrote) {\r\n      if (streamContext.pesSlices.total === 0) {\r\n        if (avpacket.dts !== NOPTS_VALUE_BIGINT) {\r\n          streamContext.pes.dts = avRescaleQ(avpacket.dts, avpacket.timeBase, stream.timeBase) + this.context.delay\r\n        }\r\n        if (avpacket.pts !== NOPTS_VALUE_BIGINT) {\r\n          streamContext.pes.pts = avRescaleQ(avpacket.pts, avpacket.timeBase, stream.timeBase) + this.context.delay\r\n        }\r\n        if (avpacket.flags & AVPacketFlags.AV_PKT_FLAG_KEY) {\r\n          streamContext.pes.randomAccessIndicator = 1\r\n        }\r\n      }\r\n      streamContext.pesSlices.total += buffer.length\r\n      streamContext.pesSlices.buffers.push(buffer)\r\n    }\r\n\r\n    return 0\r\n  }\r\n\r\n  public writeTrailer(context: AVOFormatContext): number {\r\n\r\n    array.each(context.streams, (stream) => {\r\n      const streamContext = stream.privData as MpegtsStreamContext\r\n      if (streamContext.pesSlices.total) {\r\n        ompegts.writePES(context.ioWriter, streamContext.pes, streamContext.pesSlices, stream, this.context)\r\n      }\r\n      streamContext.pesSlices.total = 0\r\n      streamContext.pesSlices.buffers = []\r\n    })\r\n\r\n    context.ioWriter.flush()\r\n\r\n    return 0\r\n  }\r\n\r\n  public flush(context: AVOFormatContext): number {\r\n    context.ioWriter.flush()\r\n    return 0\r\n  }\r\n\r\n}\r\n","/*\r\n * libmedia calculate crc32\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nexport function calculateCRC32(data: Uint8Array) {\r\n  const generatorPolynomial = 0x04C11DB7\r\n  let crc = 0xFFFFFFFF\r\n  for (let i = 0; i < data.length; i++) {\r\n    crc ^= data[i] << 24\r\n    for (let j = 0; j < 8; j++) {\r\n      if (crc & 0x80000000) {\r\n        crc = (crc << 1) ^ generatorPolynomial\r\n      }\r\n      else {\r\n        crc <<= 1\r\n      }\r\n    }\r\n  }\r\n  return crc >>> 0\r\n}\r\n","/*\r\n * libmedia create mpegts context\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport { NOPTS_VALUE } from 'avutil/constant'\r\nimport { PAT, PMT } from '../struct'\r\nimport { MpegtsContext } from '../type'\r\n\r\nexport default function createMpegtsContext(): MpegtsContext {\r\n\r\n  return {\r\n    currentProgram: NOPTS_VALUE,\r\n    currentPmtPid: NOPTS_VALUE,\r\n    tsPacketSize: NOPTS_VALUE,\r\n    hasPAT: false,\r\n    hasPMT: false,\r\n    tsSliceQueueMap: new Map(),\r\n    pat: new PAT(),\r\n    pmt: new PMT(),\r\n    program2Pmt: new Map(),\r\n    ioEnd: false,\r\n\r\n    startPid: 0x100,\r\n    delay: 0n\r\n  }\r\n}\r\n","/*\r\n * libmedia create mpegts stream context\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport { NOPTS_VALUE } from 'avutil/constant'\r\nimport { MpegtsStreamContext } from '../type'\r\n\r\nexport default function createMpegtsStreamContext(): MpegtsStreamContext {\r\n  return {\r\n    pid: NOPTS_VALUE,\r\n    filter: null,\r\n    tsPacket: null,\r\n    pes: null,\r\n    continuityCounter: 0,\r\n    pesSlices: {\r\n      total: 0,\r\n      buffers: []\r\n    },\r\n    latm: false\r\n  }\r\n}\r\n","/*\r\n * libmedia mpegts identify defined\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport { AVCodecID, AVMediaType } from 'avutil/codec'\r\n\r\nexport const TS_FEC_PACKET_SIZE = 204\r\n\r\nexport const TS_DVHS_PACKET_SIZE = 192\r\n\r\nexport const TS_PACKET_SIZE = 188\r\n\r\nexport const TS_MAX_PACKET_SIZE = 204\r\n\r\nexport const NB_PID_MAX = 8192\r\n\r\nexport const USUAL_SECTION_SIZE = 1024\r\n\r\nexport const MAX_SECTION_SIZE = 4096\r\n\r\nexport const PROBE_PACKET_MAX_BUF = 8192\r\n\r\nexport const PROBE_PACKET_MARGIN = 5\r\n\r\n/**\r\n * maximum size in which we look for synchronization if\r\n * synchronization is lost \r\n */\r\nexport const MAX_RESYNC_SIZE = 65536\r\n\r\nexport const MAX_PES_PAYLOAD = 200 * 1024\r\n\r\nexport const MAX_MP4_DESCR_COUNT = 16\r\n\r\nexport const REGISTRATION_DESCRIPTOR = 0x05\r\n\r\nexport const ISO_639_LANGUAGE_DESCRIPTOR = 0x0a\r\n\r\nexport const enum TSPid {\r\n  /**\r\n   * Program Association Table\r\n   */\r\n  PAT = 0x0000,\r\n  /**\r\n   * Conditional Access Table\r\n   */\r\n  CAT = 0x0001,\r\n  /**\r\n   * Transport Stream Description Table\r\n   */\r\n  TSDT = 0x0002,\r\n  IPMP = 0x0003,\r\n\r\n  /**\r\n   * PID from 0x0004 to 0x000F are reserved\r\n   */\r\n\r\n  /**\r\n   * Network Information Table\r\n   */\r\n  NIT = 0x0010,\r\n  /**\r\n   * Service Description Table\r\n   */\r\n  SDT = 0x0011,\r\n  /**\r\n   * Bouquet Association Table\r\n   */\r\n  BAT = 0x0011,\r\n  /**\r\n   * Event Information Table\r\n   */\r\n  EIT = 0x0012,\r\n  /**\r\n   * Running Status Table\r\n   */\r\n  RST = 0x0013,\r\n  /**\r\n   * Time and Date Table \r\n   */\r\n  TDT = 0x0014,\r\n  TOT = 0x0014,\r\n  NET_SYNC = 0x0015,\r\n  /**\r\n   * RAR Notification Table\r\n   */\r\n  RNT = 0x0016,\r\n\r\n  /**\r\n   * PID from 0x0017 to 0x001B are reserved for future use\r\n   * \r\n   */\r\n\r\n  /**\r\n   * PID value 0x001C allocated to link-local inband signalling shall not be\r\n   * used on any broadcast signals. It shall only be used between devices in a\r\n   * controlled environment. \r\n   */\r\n  LINK_LOCAL = 0x001C,\r\n  MEASUREMENT = 0x001D,\r\n  /**\r\n   * Discontinuity Information Table\r\n   */\r\n  DIT = 0x001E,\r\n  /**\r\n   * Selection Information Table\r\n   */\r\n  SIT = 0x001F,\r\n  /**\r\n   * PID from 0x0020 to 0x1FFA may be assigned as needed to PMT, elementary\r\n   * streams and other data tables\r\n   */\r\n  FIRST_OTHER = 0x0020,\r\n  LAST_OTHER = 0x1FFA,\r\n  /**\r\n   * PID 0x1FFB is used by DigiCipher 2/ATSC MGT metadata\r\n   * PID from 0x1FFC to 0x1FFE may be assigned as needed to PMT, elementary\r\n   * streams and other data tables\r\n   */\r\n\r\n  /**\r\n   * Null packet (used for fixed bandwidth padding)\r\n   */\r\n  NULL = 0x1FFF,\r\n  /**\r\n   * m2ts pids\r\n   */\r\n  M2TS_PMT = 0x0100,\r\n  M2TS_PCR = 0x1001,\r\n  M2TS_VIDEO = 0x1011,\r\n  M2TS_AUDIO_START = 0x1100,\r\n  M2TS_PGSSUB_START = 0x1200,\r\n  M2TS_TEXTSUB = 0x1800,\r\n  M2TS_SECONDARY_AUDIO_START = 0x1A00,\r\n  M2TS_SECONDARY_VIDEO_START = 0x1B00\r\n}\r\n\r\nexport const enum TSTid {\r\n  /**\r\n   * Program Association section\r\n   */\r\n  PAT = 0x00,\r\n  /**\r\n   * Conditional Access section \r\n   */\r\n  CAT = 0x01,\r\n  /**\r\n   * Program Map section\r\n   */\r\n  PMT = 0x02,\r\n  /**\r\n   * Transport Stream Description section \r\n   */\r\n  TSDT = 0x03,\r\n\r\n  /**\r\n   * TID from 0x04 to 0x3F are reserved\r\n   */\r\n\r\n  M4OD = 0x05,\r\n  /**\r\n   * Network Information section - actual network\r\n   */\r\n  NIT = 0x40,\r\n  /**\r\n   * Network Information section - actual network\r\n   */\r\n  ONIT = 0x41,\r\n  /**\r\n   * Service Description section - actual TS\r\n   */\r\n  SDT = 0x42,\r\n\r\n  /**\r\n   * TID from 0x43 to 0x45 are reserved for future use\r\n   */\r\n\r\n  /**\r\n   * Service Descrition section - other TS \r\n   */\r\n  OSDT = 0x46,\r\n\r\n  /**\r\n   * TID from 0x47 to 0x49 are reserved for future use\r\n   */\r\n\r\n  /**\r\n   * Bouquet Association section\r\n   */\r\n  BAT = 0x4A,\r\n  /**\r\n   * Update Notification Table section\r\n   */\r\n  UNT = 0x4B,\r\n  /**\r\n   * Downloadable Font Info section\r\n   */\r\n  DFI = 0x4C,\r\n\r\n  /**\r\n   * TID 0x4D is reserved for future use \r\n   */\r\n\r\n  /**\r\n   * Event Information section - actual TS\r\n   */\r\n  EIT = 0x4E,\r\n  /**\r\n   * Event Information section - other TS\r\n   */\r\n  OEIT = 0x4F,\r\n  /**\r\n   * Event Information section schedule - actual TS \r\n   */\r\n  EITS_START = 0x50,\r\n  /**\r\n   * Event Information section schedule - actual TS \r\n   */\r\n  EITS_END = 0x5F,\r\n  /**\r\n   *  Event Information section schedule - other TS\r\n   */\r\n  OEITS_START = 0x60,\r\n  /**\r\n   * Event Information section schedule - other TS\r\n   */\r\n  OEITS_END = 0x6F,\r\n  /**\r\n   * Time Date section\r\n   */\r\n  TDT = 0x70,\r\n  /**\r\n   * Running Status section\r\n   */\r\n  RST = 0x71,\r\n  /**\r\n   * Stuffing section\r\n   */\r\n  ST = 0x72,\r\n  /**\r\n   * Time Offset section\r\n   */\r\n  TOT = 0x73,\r\n  /**\r\n   * Application Inforamtion section\r\n   */\r\n  AIT = 0x74,\r\n  /**\r\n   * Container section\r\n   */\r\n  CT = 0x75,\r\n  /**\r\n   * Related Content section\r\n   */\r\n  RCT = 0x76,\r\n  /**\r\n   * Related Content section\r\n   */\r\n  CIT = 0x77,\r\n  /**\r\n   * MPE-FEC section\r\n   */\r\n  MPE_FEC = 0x78,\r\n  /**\r\n   * Resolution Provider Notification section\r\n   */\r\n  RPNT = 0x79,\r\n  /**\r\n   * MPE-IFEC section\r\n   */\r\n  MPE_IFEC = 0x7A,\r\n  /**\r\n   * Protection Message section\r\n   */\r\n  PROTMT = 0x7B,\r\n\r\n  /**\r\n   * TID from 0x7C to 0x7D are reserved for future use\r\n   */\r\n\r\n  /**\r\n   * Discontinuity Information section\r\n   */\r\n  DIT = 0x7E,\r\n  /**\r\n   * Selection Information section\r\n   */\r\n  SIT = 0x7F\r\n\r\n  /**\r\n   * TID from 0x80 to 0xFE are user defined\r\n   * TID 0xFF is reserved\r\n   */\r\n}\r\n\r\nexport const enum TSStreamType {\r\n  NONE = 0x00,\r\n  VIDEO_MPEG1 = 0x01,\r\n  VIDEO_MPEG2 = 0x02,\r\n  AUDIO_MPEG1 = 0x03,\r\n  AUDIO_MPEG2 = 0x04,\r\n  PRIVATE_SECTION = 0x05,\r\n  PRIVATE_DATA = 0x06,\r\n  AUDIO_AAC = 0x0f,\r\n  AUDIO_AAC_LATM = 0x11,\r\n  VIDEO_MPEG4 = 0x10,\r\n  METADATA = 0x15,\r\n  VIDEO_H264 = 0x1b,\r\n  VIDEO_HEVC = 0x24,\r\n  VIDEO_VVC = 0x33,\r\n  VIDEO_CAVS = 0x42,\r\n  VIDEO_VC1 = 0xea,\r\n  VIDEO_DIRAC = 0xd1,\r\n\r\n  AUDIO_AC3 = 0x81,\r\n  AUDIO_DTS = 0x82,\r\n  AUDIO_TRUEHD = 0x83,\r\n  kSCTE35 = 0x86,\r\n  AUDIO_EAC3 = 0x87\r\n}\r\n\r\n/**\r\n * ISO/IEC 13818-1 Table 2-22\r\n */\r\nexport const enum TSStreamId {\r\n  PROGRAM_STREAM_MAP = 0xbc,\r\n  PRIVATE_STREAM_1 = 0xbd,\r\n  PADDING_STREAM = 0xbe,\r\n  PRIVATE_STREAM_2 = 0xbf,\r\n  AUDIO_STREAM_0 = 0xc0,\r\n  VIDEO_STREAM_0 = 0xe0,\r\n  ECM_STREAM = 0xf0,\r\n  EMM_STREAM = 0xf1,\r\n  DSMCC_STREAM = 0xf2,\r\n  TYPE_E_STREAM = 0xf8,\r\n  METADATA_STREAM = 0xfc,\r\n  EXTENDED_STREAM_ID = 0xfd,\r\n  PROGRAM_STREAM_DIRECTORY = 0xff\r\n}\r\n\r\n/**\r\n * ISO/IEC 13818-1 Table 2-45\r\n */\r\nexport const enum TSDescriptor {\r\n  VIDEO_STREAM = 0x02,\r\n  REGISTRATION = 0x05,\r\n  ISO_639_LANGUAGE = 0x0a,\r\n  IOD = 0x1d,\r\n  SL = 0x1e,\r\n  FMC = 0x1f,\r\n  METADATA = 0x26,\r\n  METADATA_STD = 0x27\r\n}\r\n\r\nexport const StreamType2AVCodecId: Partial<Record<TSStreamType, [AVMediaType, AVCodecID]>> = {\r\n  [TSStreamType.AUDIO_AAC]: [AVMediaType.AVMEDIA_TYPE_AUDIO, AVCodecID.AV_CODEC_ID_AAC],\r\n  [TSStreamType.AUDIO_AAC_LATM]: [AVMediaType.AVMEDIA_TYPE_AUDIO, AVCodecID.AV_CODEC_ID_AAC],\r\n  [TSStreamType.AUDIO_MPEG1]: [AVMediaType.AVMEDIA_TYPE_AUDIO, AVCodecID.AV_CODEC_ID_MP3],\r\n  [TSStreamType.AUDIO_MPEG2]: [AVMediaType.AVMEDIA_TYPE_AUDIO, AVCodecID.AV_CODEC_ID_MP3],\r\n  [TSStreamType.VIDEO_H264]: [AVMediaType.AVMEDIA_TYPE_VIDEO, AVCodecID.AV_CODEC_ID_H264],\r\n  [TSStreamType.VIDEO_MPEG4]: [AVMediaType.AVMEDIA_TYPE_VIDEO, AVCodecID.AV_CODEC_ID_MPEG4],\r\n  [TSStreamType.VIDEO_HEVC]: [AVMediaType.AVMEDIA_TYPE_VIDEO, AVCodecID.AV_CODEC_ID_HEVC],\r\n  [TSStreamType.VIDEO_VVC]: [AVMediaType.AVMEDIA_TYPE_VIDEO, AVCodecID.AV_CODEC_ID_VVC],\r\n  [TSStreamType.AUDIO_AC3]: [AVMediaType.AVMEDIA_TYPE_AUDIO, AVCodecID.AV_CODEC_ID_AC3],\r\n  [TSStreamType.AUDIO_EAC3]: [AVMediaType.AVMEDIA_TYPE_AUDIO, AVCodecID.AV_CODEC_ID_EAC3]\r\n}\r\n","/*\r\n * libmedia mpegts encode util\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport IOWriter from 'common/io/IOWriterSync'\r\nimport { PAT, PES, PMT, SectionPacket, TSPacket } from './struct'\r\nimport { MpegtsContext, MpegtsStreamContext } from './type'\r\nimport * as mpegts from './mpegts'\r\nimport * as logger from 'common/util/logger'\r\nimport Stream from '../../AVStream'\r\nimport mktag from '../../function/mktag'\r\nimport { AVCodecID, AVMediaType } from 'avutil/codec'\r\nimport concatTypeArray from 'common/function/concatTypeArray'\r\nimport { NOPTS_VALUE_BIGINT, UINT16_MAX } from 'avutil/constant'\r\nimport { calculateCRC32 } from './function/crc32'\r\n\r\nfunction getAdaptationFieldLength(tsPacket: TSPacket) {\r\n  if (tsPacket.adaptationFieldControl !== 0x02 && tsPacket.adaptationFieldControl !== 0x03) {\r\n    return 0\r\n  }\r\n\r\n  if (tsPacket.adaptationFieldControl === 0x02) {\r\n    return mpegts.TS_PACKET_SIZE - 4\r\n  }\r\n\r\n  let len = 2\r\n\r\n  if (tsPacket.adaptationFieldInfo.pcrFlag) {\r\n    len += 6\r\n  }\r\n  if (tsPacket.adaptationFieldInfo.opcrFlag) {\r\n    len += 6\r\n  }\r\n  if (tsPacket.adaptationFieldInfo.splicingPointFlag) {\r\n    len += 1\r\n  }\r\n  if (tsPacket.adaptationFieldInfo.transportPrivateDataFlag) {\r\n    len += tsPacket.adaptationFieldInfo.transportPrivateData\r\n      ? tsPacket.adaptationFieldInfo.transportPrivateData.length\r\n      : 0\r\n  }\r\n  if (tsPacket.adaptationFieldInfo.adaptationFieldExtensionFlag) {\r\n    len += tsPacket.adaptationFieldInfo.extension ? tsPacket.adaptationFieldInfo.extension.length : 0\r\n  }\r\n\r\n  if (len > 256) {\r\n    logger.warn('adaptationField size is too large')\r\n  }\r\n\r\n  return len\r\n}\r\n\r\nfunction getPESHeaderLength(pes: PES) {\r\n  let len = 6\r\n\r\n  const streamId = pes.streamId\r\n\r\n  if (streamId !== mpegts.TSStreamId.PROGRAM_STREAM_MAP\r\n    && streamId !== mpegts.TSStreamId.PADDING_STREAM\r\n    && streamId !== mpegts.TSStreamId.PRIVATE_STREAM_2\r\n    && streamId !== mpegts.TSStreamId.ECM_STREAM\r\n    && streamId !== mpegts.TSStreamId.EMM_STREAM\r\n    && streamId !== mpegts.TSStreamId.PROGRAM_STREAM_DIRECTORY\r\n    && streamId !== mpegts.TSStreamId.DSMCC_STREAM\r\n    && streamId !== mpegts.TSStreamId.TYPE_E_STREAM\r\n  ) {\r\n    len += 3\r\n\r\n    if (pes.pts !== NOPTS_VALUE_BIGINT) {\r\n      len += 5\r\n    }\r\n    if (pes.dts !== NOPTS_VALUE_BIGINT && pes.pts !== NOPTS_VALUE_BIGINT && pes.dts !== pes.pts) {\r\n      len += 5\r\n    }\r\n  }\r\n\r\n  return len\r\n}\r\n\r\nfunction writePESPayload(\r\n  ioWriter: IOWriter,\r\n  pes: PES,\r\n  payload: Uint8Array,\r\n  stream: Stream,\r\n  mpegtsContext: MpegtsContext\r\n) {\r\n\r\n  const streamContext = stream.privData as MpegtsStreamContext\r\n  const tsPacket = streamContext.tsPacket\r\n\r\n  if (pes.pid === mpegtsContext.pmt.pcrPid) {\r\n    tsPacket.adaptationFieldControl = 0x03\r\n    tsPacket.adaptationFieldInfo.pcrFlag = 1\r\n    tsPacket.adaptationFieldInfo.pcr = pes.dts * 300n\r\n  }\r\n  tsPacket.adaptationFieldInfo.randomAccessIndicator = pes.randomAccessIndicator\r\n\r\n  if (pes.randomAccessIndicator) {\r\n    tsPacket.adaptationFieldControl = 0x03\r\n  }\r\n\r\n  let adaptationFieldLength = getAdaptationFieldLength(tsPacket)\r\n\r\n  let continuityCounter = streamContext.continuityCounter\r\n\r\n  if (4 + adaptationFieldLength + payload.length <= mpegts.TS_PACKET_SIZE) {\r\n    tsPacket.payloadUnitStartIndicator = 0x01\r\n    tsPacket.payload = payload\r\n    tsPacket.continuityCounter = (continuityCounter++) % 16\r\n\r\n    writeTSPacket(ioWriter, tsPacket, mpegtsContext)\r\n\r\n    streamContext.continuityCounter = continuityCounter % 16\r\n    return\r\n  }\r\n\r\n  let len = mpegts.TS_PACKET_SIZE - (4 + adaptationFieldLength)\r\n  let pos = 0\r\n\r\n  while (pos < payload.length) {\r\n\r\n    let next = Math.min(pos + len, payload.length)\r\n\r\n    if (pos === 0) {\r\n      tsPacket.payloadUnitStartIndicator = 0x01\r\n    }\r\n    else {\r\n      tsPacket.payloadUnitStartIndicator = 0x00\r\n    }\r\n\r\n    if (tsPacket.adaptationFieldControl === 0x01 && (next - pos + 4 === mpegts.TS_PACKET_SIZE - 1)) {\r\n      // padding  2 \r\n      next--\r\n    }\r\n\r\n    tsPacket.payload = payload.subarray(pos, next)\r\n    tsPacket.continuityCounter = (continuityCounter++) % 16\r\n\r\n    writeTSPacket(ioWriter, tsPacket, mpegtsContext)\r\n\r\n    if (pos === 0) {\r\n      tsPacket.adaptationFieldInfo.randomAccessIndicator = 0\r\n      tsPacket.adaptationFieldControl = 0x01\r\n      tsPacket.adaptationFieldInfo.pcrFlag = 0\r\n      adaptationFieldLength = getAdaptationFieldLength(tsPacket)\r\n      len = mpegts.TS_PACKET_SIZE - (4 + adaptationFieldLength)\r\n    }\r\n\r\n    pos = next\r\n  }\r\n\r\n  streamContext.continuityCounter = continuityCounter % 16\r\n}\r\n\r\nexport function getStreamType(stream: Stream) {\r\n\r\n  const context = stream.privData as MpegtsStreamContext || {} as any\r\n\r\n  switch (stream.codecpar.codecId) {\r\n    case AVCodecID.AV_CODEC_ID_MPEG1VIDEO:\r\n    case AVCodecID.AV_CODEC_ID_MPEG2VIDEO:\r\n      return mpegts.TSStreamType.VIDEO_MPEG2\r\n    case AVCodecID.AV_CODEC_ID_MPEG4:\r\n      return mpegts.TSStreamType.VIDEO_MPEG4\r\n    case AVCodecID.AV_CODEC_ID_H264:\r\n      return mpegts.TSStreamType.VIDEO_H264\r\n    case AVCodecID.AV_CODEC_ID_CAVS:\r\n      return mpegts.TSStreamType.VIDEO_CAVS\r\n    case AVCodecID.AV_CODEC_ID_HEVC:\r\n      return mpegts.TSStreamType.VIDEO_HEVC\r\n    case AVCodecID.AV_CODEC_ID_VVC:\r\n      return mpegts.TSStreamType.VIDEO_VVC\r\n    case AVCodecID.AV_CODEC_ID_DIRAC:\r\n      return mpegts.TSStreamType.VIDEO_DIRAC\r\n    case AVCodecID.AV_CODEC_ID_VC1:\r\n      return mpegts.TSStreamType.VIDEO_VC1\r\n\r\n    case AVCodecID.AV_CODEC_ID_MP2:\r\n    case AVCodecID.AV_CODEC_ID_MP3:\r\n      return stream.codecpar.sampleRate < 32000\r\n        ? mpegts.TSStreamType.AUDIO_MPEG2\r\n        : mpegts.TSStreamType.AUDIO_MPEG1\r\n\r\n    case AVCodecID.AV_CODEC_ID_AAC:\r\n      return context.latm\r\n        ? mpegts.TSStreamType.AUDIO_AAC_LATM\r\n        : mpegts.TSStreamType.AUDIO_AAC\r\n    case AVCodecID.AV_CODEC_ID_AAC_LATM:\r\n      return mpegts.TSStreamType.AUDIO_AAC_LATM\r\n    case AVCodecID.AV_CODEC_ID_AC3:\r\n      return mpegts.TSStreamType.AUDIO_AC3\r\n    case AVCodecID.AV_CODEC_ID_OPUS:\r\n    case AVCodecID.AV_CODEC_ID_AV1:\r\n      return mpegts.TSStreamType.PRIVATE_DATA\r\n    case AVCodecID.AV_CODEC_ID_TRUEHD:\r\n      return mpegts.TSStreamType.AUDIO_TRUEHD\r\n    case AVCodecID.AV_CODEC_ID_EAC3:\r\n      return mpegts.TSStreamType.AUDIO_EAC3\r\n    case AVCodecID.AV_CODEC_ID_DTS:\r\n      return mpegts.TSStreamType.AUDIO_DTS\r\n    case AVCodecID.AV_CODEC_ID_DVB_SUBTITLE:\r\n    case AVCodecID.AV_CODEC_ID_SMPTE_KLV:\r\n      return mpegts.TSStreamType.PRIVATE_DATA\r\n\r\n    default:\r\n      return mpegts.TSStreamType.PRIVATE_DATA\r\n  }\r\n}\r\n\r\nexport function getStreamId(stream: Stream) {\r\n  if (stream.codecpar.codecType === AVMediaType.AVMEDIA_TYPE_VIDEO) {\r\n    if (stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_DIRAC) {\r\n      return mpegts.TSStreamId.EXTENDED_STREAM_ID\r\n    }\r\n    else {\r\n      return mpegts.TSStreamId.VIDEO_STREAM_0\r\n    }\r\n  }\r\n  else if (stream.codecpar.codecType === AVMediaType.AVMEDIA_TYPE_AUDIO\r\n    && (\r\n      stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_MP2\r\n        || stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_MP3\r\n        || stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_AAC\r\n    )\r\n  ) {\r\n    return mpegts.TSStreamId.AUDIO_STREAM_0\r\n  }\r\n  else if (stream.codecpar.codecType === AVMediaType.AVMEDIA_TYPE_AUDIO\r\n    && stream.codecpar.codecId === AVCodecID.AV_CODEC_ID_AC3\r\n  ) {\r\n    return mpegts.TSStreamId.EXTENDED_STREAM_ID\r\n  }\r\n  else if (stream.codecpar.codecType === AVMediaType.AVMEDIA_TYPE_DATA) {\r\n    return mpegts.TSStreamId.METADATA_STREAM\r\n  }\r\n  else {\r\n    return mpegts.TSStreamId.PRIVATE_STREAM_1\r\n  }\r\n}\r\n\r\nexport function getPATPayload(pat: PAT) {\r\n\r\n  const buffer = new Uint8Array(1024)\r\n\r\n  buffer[1] = 0x00\r\n  buffer[2] = 0xb0\r\n\r\n  // transport_stream_id 1 \r\n  buffer[5] = 1\r\n\r\n  // current_next_indicator\r\n  buffer[6] = (3 << 6) | 0x01\r\n\r\n  let pos = 9\r\n\r\n  if (pat.networkPid > -1) {\r\n    pos += 2\r\n    buffer[pos++] = (7 << 5) | ((pat.networkPid >> 8) & 0x1f)\r\n    buffer[pos++] = (pat.networkPid & 0xff)\r\n  }\r\n\r\n  pat.program2PmtPid.forEach((pid, programNumber) => {\r\n    buffer[pos++] = (programNumber >> 8) & 0xff\r\n    buffer[pos++] = programNumber & 0xff\r\n    buffer[pos++] = (7 << 5) | (pid >> 8) & 0x1f\r\n    buffer[pos++] = pid & 0xff\r\n  })\r\n\r\n  const crcPos = pos\r\n  pos += 4\r\n\r\n  for (let i = pos; i < mpegts.TS_PACKET_SIZE - 4; i++) {\r\n    buffer[i] = 0xff\r\n  }\r\n\r\n  const len = (pos - 1) - 3\r\n\r\n  buffer[2] |= ((len >> 8) & 0x0f)\r\n  buffer[3] = len & 0xff\r\n\r\n  // CRC32\r\n  const crc32 = calculateCRC32(buffer.subarray(1, crcPos))\r\n  buffer[crcPos] = (crc32 >> 24) & 0xff\r\n  buffer[crcPos + 1] = (crc32 >> 16) & 0xff\r\n  buffer[crcPos + 2] = (crc32 >> 8) & 0xff\r\n  buffer[crcPos + 3] = crc32 & 0xff\r\n\r\n  return buffer.slice(0, mpegts.TS_PACKET_SIZE - 4)\r\n}\r\n\r\nexport function getPMTPayload(pmt: PMT, streams: Stream[]) {\r\n  const buffer = new Uint8Array(1024)\r\n\r\n  buffer[1] = 0x02\r\n  buffer[2] = 0xb0\r\n\r\n  buffer[4] = ((pmt.programNumber >> 8) & 0x0f)\r\n  buffer[5] = pmt.programNumber & 0xff\r\n\r\n  // current_next_indicator\r\n  buffer[6] = (3 << 6) | 0x01\r\n\r\n  let pos = 9\r\n\r\n  buffer[pos++] = (7 << 5) | (pmt.pcrPid >> 8) & 0x1f\r\n  buffer[pos++] = pmt.pcrPid & 0xff\r\n\r\n  const programInfoLengthPos = pos\r\n  pos += 2\r\n\r\n  function putRegistrationDescriptor(tag: number) {\r\n    buffer[pos++] = mpegts.REGISTRATION_DESCRIPTOR\r\n    buffer[pos++] = 4\r\n    buffer[pos++] = tag >> 24\r\n    buffer[pos++] = tag >> 16\r\n    buffer[pos++] = tag >> 8\r\n    buffer[pos++] = tag\r\n  }\r\n\r\n  let len = 0xf000 | (pos - programInfoLengthPos - 2)\r\n  buffer[programInfoLengthPos] = len >> 8\r\n  buffer[programInfoLengthPos + 1] = len\r\n\r\n  for (let i = 0; i < streams.length; i++) {\r\n    const streamType = getStreamType(streams[i])\r\n    buffer[pos++] = streamType\r\n\r\n    const streamContext = streams[i].privData as MpegtsStreamContext\r\n\r\n    buffer[pos++] = (7 << 5) | (streamContext.pid >> 8) & 0x1f\r\n    buffer[pos++] = streamContext.pid  & 0xff\r\n\r\n    const descLengthPos = pos\r\n    pos += 2\r\n\r\n    const codecId = streams[i].codecpar.codecId\r\n\r\n    switch (streams[i].codecpar.codecType) {\r\n      case AVMediaType.AVMEDIA_TYPE_AUDIO: {\r\n        if (codecId === AVCodecID.AV_CODEC_ID_AC3) {\r\n          putRegistrationDescriptor(mktag('AC-3'))\r\n        }\r\n        if (codecId === AVCodecID.AV_CODEC_ID_EAC3) {\r\n          putRegistrationDescriptor(mktag('EAC3'))\r\n        }\r\n        if (codecId === AVCodecID.AV_CODEC_ID_S302M) {\r\n          putRegistrationDescriptor(mktag('BSSD'))\r\n        }\r\n        if (codecId === AVCodecID.AV_CODEC_ID_OPUS) {\r\n          putRegistrationDescriptor(mktag('Opus'))\r\n          buffer[pos++] = 0x7f\r\n          buffer[pos++] = 2\r\n          buffer[pos++] = 0x80\r\n          buffer[pos++] = streams[i].codecpar.chLayout.nbChannels\r\n        }\r\n        // language und\r\n        buffer[pos++] = mpegts.ISO_639_LANGUAGE_DESCRIPTOR\r\n        buffer[pos++] = 4\r\n        buffer[pos++] = 117\r\n        buffer[pos++] = 110\r\n        buffer[pos++] = 100\r\n        buffer[pos++] = 0\r\n        break\r\n      }\r\n      case AVMediaType.AVMEDIA_TYPE_VIDEO: {\r\n        if (codecId === AVCodecID.AV_CODEC_ID_AV1) {\r\n          putRegistrationDescriptor(mktag('AV01'))\r\n          if (streams[i].codecpar.extradata) {\r\n            buffer[pos++] = 0x80\r\n            buffer[pos++] = streams[i].codecpar.extradataSize\r\n            for (let j = 0; j < streams[i].codecpar.extradataSize; j++) {\r\n              buffer[pos++] = accessof(reinterpret_cast<pointer<uint8>>(streams[i].codecpar.extradata + j))\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    let len = 0xf000 | (pos - descLengthPos - 2)\r\n    buffer[descLengthPos] = len >> 8\r\n    buffer[descLengthPos + 1] = len\r\n  }\r\n\r\n  const crcPos = pos\r\n  pos += 4\r\n\r\n  for (let i = pos; i < mpegts.TS_PACKET_SIZE - 4; i++) {\r\n    buffer[i] = 0xff\r\n  }\r\n\r\n  len = (pos - 1) - 3\r\n  buffer[2] |= ((len >> 8) & 0x0f)\r\n  buffer[3] = len & 0xff\r\n\r\n  // CRC32\r\n  const crc32 = calculateCRC32(buffer.subarray(1, crcPos))\r\n  buffer[crcPos] = (crc32 >> 24) & 0xff\r\n  buffer[crcPos + 1] = (crc32 >> 16) & 0xff\r\n  buffer[crcPos + 2] = (crc32 >> 8) & 0xff\r\n  buffer[crcPos + 3] = crc32 & 0xff\r\n  return buffer.slice(0, mpegts.TS_PACKET_SIZE - 4)\r\n}\r\n\r\nexport function getSDTPayload() {\r\n  const buffer = new Uint8Array(1024)\r\n\r\n  buffer[1] = 0x42\r\n  buffer[2] = 0xf0\r\n\r\n  // transport_stream_id 1 \r\n  buffer[5] = 1\r\n\r\n  // current_next_indicator\r\n  buffer[6] = (3 << 6) | 0x01\r\n\r\n  let pos = 9\r\n\r\n  // original_network_id\r\n  buffer[pos++] = 0xff\r\n  buffer[pos++] = 1\r\n\r\n  buffer[pos++] = 0xff\r\n\r\n  /*\r\n   * put service\r\n   * service id\r\n   */\r\n  buffer[pos++] = 0\r\n  buffer[pos++] = 1\r\n\r\n  /* currently no EIT info */\r\n  buffer[pos++] =  0xfc | 0x00\r\n\r\n  const descListLenPtr = pos\r\n  pos += 2\r\n\r\n  // write only one descriptor for the service name and provider */\r\n  buffer[pos++] = 0x48\r\n\r\n  const descLenPtr = pos++\r\n\r\n  // service_type\r\n  buffer[pos++] = 1\r\n\r\n  const providerName = 'format-js'\r\n  const serviceName = 'Service01'\r\n\r\n  buffer[pos++] = providerName.length\r\n  for (let i = 0; i < providerName.length; i++) {\r\n    buffer[pos] = providerName.charCodeAt(i)\r\n    pos++\r\n  }\r\n\r\n  buffer[pos++] = serviceName.length\r\n  for (let i = 0; i < serviceName.length; i++) {\r\n    buffer[pos] = serviceName.charCodeAt(i)\r\n    pos++\r\n  }\r\n\r\n  buffer[descLenPtr] = pos - descLenPtr - 1\r\n\r\n  // fill descriptor length \r\n  let value = (4 << 13) | (0 << 12) | (pos - descListLenPtr - 2)\r\n  buffer[descListLenPtr] = (value >> 8) & 0xff\r\n  buffer[descListLenPtr + 1] = value & 0xff\r\n\r\n  const crcPos = pos\r\n  pos += 4\r\n\r\n  for (let i = pos; i < mpegts.TS_PACKET_SIZE - 4; i++) {\r\n    buffer[i] = 0xff\r\n  }\r\n\r\n  const len = (pos - 1) - 3\r\n\r\n  buffer[2] |= ((len >> 8) & 0x0f)\r\n  buffer[3] = len & 0xff\r\n\r\n  // CRC32\r\n  const crc32 = calculateCRC32(buffer.subarray(1, crcPos))\r\n  buffer[crcPos] = (crc32 >> 24) & 0xff\r\n  buffer[crcPos + 1] = (crc32 >> 16) & 0xff\r\n  buffer[crcPos + 2] = (crc32 >> 8) & 0xff\r\n  buffer[crcPos + 3] = crc32 & 0xff\r\n\r\n  return buffer.slice(0, mpegts.TS_PACKET_SIZE - 4)\r\n}\r\n\r\nexport function writeTSPacket(ioWriter: IOWriter, tsPacket: TSPacket, mpegtsContext: MpegtsContext) {\r\n  // TODO\r\n  if (mpegtsContext.tsPacketSize === mpegts.TS_DVHS_PACKET_SIZE) {\r\n    // skip ATS field (2-bits copy-control + 30-bits timestamp) for m2ts\r\n    ioWriter.skip(4)\r\n  }\r\n\r\n  if (!tsPacket.payload || tsPacket.payload.length === 0) {\r\n    tsPacket.adaptationFieldControl = 0x02\r\n  }\r\n\r\n  if (tsPacket.adaptationFieldControl === 0x01\r\n        && (tsPacket.payload.length + 4) < mpegts.TS_PACKET_SIZE\r\n  ) {\r\n    tsPacket.adaptationFieldControl = 0x03\r\n  }\r\n\r\n  const pos = ioWriter.getPos()\r\n\r\n  ioWriter.writeUint8(0x47)\r\n\r\n  let byte = 0\r\n\r\n  if (tsPacket.payloadUnitStartIndicator) {\r\n    // Payload unit start indicator\r\n    byte |= (1 << 6)\r\n  }\r\n\r\n  byte |= (tsPacket.transportPriority << 5)\r\n\r\n  // pid  5 \r\n  byte |= (tsPacket.pid >> 8)\r\n\r\n  ioWriter.writeUint8(byte)\r\n  // pid  8 \r\n  ioWriter.writeUint8(tsPacket.pid & 0xff)\r\n\r\n  byte = ((tsPacket.transportScramblingControl & 0x03) << 6)\r\n  byte |= ((tsPacket.adaptationFieldControl & 0x03) << 4)\r\n  byte |= (tsPacket.continuityCounter & 0x0f)\r\n  ioWriter.writeUint8(byte)\r\n\r\n  let adaptationFieldLength = getAdaptationFieldLength(tsPacket)\r\n\r\n  let paddingLen = mpegts.TS_PACKET_SIZE - 4 - adaptationFieldLength\r\n  if (tsPacket.payload?.length) {\r\n    paddingLen -= tsPacket.payload.length\r\n  }\r\n\r\n  if (tsPacket.adaptationFieldControl === 0x02 || tsPacket.adaptationFieldControl === 0x03) {\r\n    const now = ioWriter.getPos()\r\n\r\n    ioWriter.writeUint8(adaptationFieldLength - 1 + paddingLen)\r\n\r\n    byte = ((tsPacket.adaptationFieldInfo.discontinuityIndicator & 0x01) << 7)\r\n    byte |= ((tsPacket.adaptationFieldInfo.randomAccessIndicator & 0x01) << 6)\r\n    byte |= ((tsPacket.adaptationFieldInfo.elementaryStreamPriorityIndicator & 0x01) << 5)\r\n    byte |= ((tsPacket.adaptationFieldInfo.pcrFlag & 0x01) << 4)\r\n    byte |= ((tsPacket.adaptationFieldInfo.opcrFlag & 0x01) << 3)\r\n    byte |= ((tsPacket.adaptationFieldInfo.splicingPointFlag & 0x01) << 2)\r\n    byte |= ((tsPacket.adaptationFieldInfo.transportPrivateDataFlag & 0x01) << 1)\r\n    byte |= (tsPacket.adaptationFieldInfo.adaptationFieldExtensionFlag & 0x01)\r\n\r\n    ioWriter.writeUint8(byte)\r\n\r\n    if (tsPacket.adaptationFieldInfo.pcrFlag) {\r\n      const pcrLow = Number(tsPacket.adaptationFieldInfo.pcr % 300n)\r\n      const pcrHigh = Number((tsPacket.adaptationFieldInfo.pcr - static_cast<int64>(pcrLow)) / 300n)\r\n      ioWriter.writeUint8((pcrHigh >> 25) & 0xff)\r\n      ioWriter.writeUint8((pcrHigh >> 17) & 0xff)\r\n      ioWriter.writeUint8((pcrHigh >> 9) & 0xff)\r\n      ioWriter.writeUint8((pcrHigh >> 1) & 0xff)\r\n      ioWriter.writeUint8((pcrHigh << 7) | (pcrLow >> 8) | 0x7e)\r\n      ioWriter.writeUint8(pcrLow)\r\n    }\r\n    if (tsPacket.adaptationFieldInfo.opcrFlag) {\r\n      const pcrLow = Number(tsPacket.adaptationFieldInfo.pcr % 300n)\r\n      const pcrHigh = Number((tsPacket.adaptationFieldInfo.pcr - static_cast<int64>(pcrLow)) / 300n)\r\n      ioWriter.writeUint8((pcrHigh >> 25) & 0xff)\r\n      ioWriter.writeUint8((pcrHigh >> 17) & 0xff)\r\n      ioWriter.writeUint8((pcrHigh >> 9) & 0xff)\r\n      ioWriter.writeUint8((pcrHigh >> 1) & 0xff)\r\n      ioWriter.writeUint8((pcrHigh << 7) | (pcrLow >> 8) | 0x7e)\r\n      ioWriter.writeUint8(pcrLow)\r\n    }\r\n\r\n    if (tsPacket.adaptationFieldInfo.splicingPointFlag) {\r\n      ioWriter.writeUint8(tsPacket.adaptationFieldInfo.spliceCountDown)\r\n    }\r\n\r\n    if (tsPacket.adaptationFieldInfo.transportPrivateDataFlag) {\r\n      if (tsPacket.adaptationFieldInfo.transportPrivateData\r\n        && tsPacket.adaptationFieldInfo.transportPrivateData.length\r\n      ) {\r\n        ioWriter.writeUint8(tsPacket.adaptationFieldInfo.transportPrivateData.length)\r\n        ioWriter.writeBuffer(tsPacket.adaptationFieldInfo.transportPrivateData)\r\n      }\r\n      else {\r\n        ioWriter.writeUint8(0)\r\n      }\r\n    }\r\n\r\n    if (tsPacket.adaptationFieldInfo.adaptationFieldExtensionFlag) {\r\n      if (tsPacket.adaptationFieldInfo.extension && tsPacket.adaptationFieldInfo.extension.length) {\r\n        ioWriter.writeUint8(tsPacket.adaptationFieldInfo.extension.length)\r\n        ioWriter.writeBuffer(tsPacket.adaptationFieldInfo.extension)\r\n      }\r\n      else {\r\n        ioWriter.writeUint8(0)\r\n      }\r\n    }\r\n\r\n    const wroteAdaptationFieldLength = Number(ioWriter.getPos() - now)\r\n\r\n    if (wroteAdaptationFieldLength < adaptationFieldLength) {\r\n      ioWriter.skip(adaptationFieldLength - wroteAdaptationFieldLength)\r\n    }\r\n\r\n    while (paddingLen > 0) {\r\n      ioWriter.writeUint8(0xff)\r\n      paddingLen--\r\n    }\r\n  }\r\n\r\n  if ((tsPacket.adaptationFieldControl === 0x01 || tsPacket.adaptationFieldControl === 0x03)) {\r\n    if (tsPacket.payload?.length) {\r\n      ioWriter.writeBuffer(tsPacket.payload)\r\n    }\r\n  }\r\n\r\n  if (Number(ioWriter.getPos() - pos) !== mpegts.TS_PACKET_SIZE) {\r\n    logger.error(`write error data size to ts packet, need ${mpegts.TS_PACKET_SIZE}, wrote: ${Number(ioWriter.getPos() - pos)}`)\r\n  }\r\n\r\n  // TODO\r\n  if (mpegtsContext.tsPacketSize === mpegts.TS_FEC_PACKET_SIZE) {\r\n    // 16 crc\r\n    ioWriter.skip(16)\r\n  }\r\n}\r\n\r\nfunction writePts(buffer: Uint8Array, pos: number, fourBits: number, pts: bigint) {\r\n  let value = fourBits << 4 | ((Number(pts >> 30n) & 0x07) << 1) | 1\r\n  buffer[pos++] = value\r\n  value = ((Number(pts >> 15n) & 0x7fff) << 1) | 1\r\n  buffer[pos++] = (value >> 8) & 0xff\r\n  buffer[pos++] = value & 0xff\r\n  value = (Number(pts & 0x7fffn) << 1) | 1\r\n  buffer[pos++] = (value >> 8) & 0xff\r\n  buffer[pos++] = value & 0xff\r\n}\r\n\r\nexport function writePES(\r\n  ioWriter: IOWriter,\r\n  pes: PES,\r\n  pesSlices: {\r\n    total: number\r\n    buffers: Uint8Array[]\r\n  },\r\n  stream: Stream,\r\n  mpegtsContext: MpegtsContext\r\n) {\r\n  const streamId = pes.streamId\r\n  const header = new Uint8Array(getPESHeaderLength(pes))\r\n\r\n  header[2] = 0x01\r\n  header[3] = streamId\r\n\r\n  let len = pesSlices.total\r\n\r\n  if (streamId !== mpegts.TSStreamId.PROGRAM_STREAM_MAP\r\n    && streamId !== mpegts.TSStreamId.PADDING_STREAM\r\n    && streamId !== mpegts.TSStreamId.PRIVATE_STREAM_2\r\n    && streamId !== mpegts.TSStreamId.ECM_STREAM\r\n    && streamId !== mpegts.TSStreamId.EMM_STREAM\r\n    && streamId !== mpegts.TSStreamId.PROGRAM_STREAM_DIRECTORY\r\n    && streamId !== mpegts.TSStreamId.DSMCC_STREAM\r\n    && streamId !== mpegts.TSStreamId.TYPE_E_STREAM\r\n  ) {\r\n    let flags = 0\r\n    let headerLen = 0\r\n    if (pes.pts !== NOPTS_VALUE_BIGINT) {\r\n      headerLen += 5\r\n      flags |= 0x80\r\n    }\r\n    if (pes.dts !== NOPTS_VALUE_BIGINT && pes.pts !== NOPTS_VALUE_BIGINT && pes.dts !== pes.pts) {\r\n      headerLen += 5\r\n      flags |= 0x40\r\n    }\r\n\r\n    let value  = 0x80\r\n    /* data alignment indicator is required for subtitle and data streams */\r\n    if (stream.codecpar.codecType === AVMediaType.AVMEDIA_TYPE_SUBTITLE\r\n      || stream.codecpar.codecType === AVMediaType.AVMEDIA_TYPE_DATA\r\n    ) {\r\n      value |= 0x04\r\n    }\r\n    header[6] = value\r\n    header[7] = flags\r\n    header[8] = headerLen\r\n\r\n    len += (headerLen + 3)\r\n\r\n    if (pes.pts !== NOPTS_VALUE_BIGINT) {\r\n      writePts(header, 9, flags >> 6, pes.pts)\r\n    }\r\n    if (pes.dts !== NOPTS_VALUE_BIGINT && pes.pts !== NOPTS_VALUE_BIGINT && pes.dts !== pes.pts) {\r\n      writePts(header, 14, 1, pes.dts)\r\n    }\r\n  }\r\n\r\n  if (len <= UINT16_MAX && stream.codecpar.codecType !== AVMediaType.AVMEDIA_TYPE_VIDEO) {\r\n    header[4] = (len >> 8) & 0xff\r\n    header[5] = len & 0xff\r\n  }\r\n\r\n  writePESPayload(ioWriter, pes, concatTypeArray(Uint8Array, [header, ...pesSlices.buffers]), stream, mpegtsContext)\r\n}\r\n\r\nexport function writeSection(ioWriter: IOWriter, packet: SectionPacket, mpegtsContext: MpegtsContext) {\r\n  const adaptationFieldLength = getAdaptationFieldLength(packet)\r\n\r\n  let continuityCounter = packet.continuityCounter\r\n\r\n  if (4 + adaptationFieldLength + packet.payload.length <= mpegts.TS_PACKET_SIZE) {\r\n    packet.payloadUnitStartIndicator = 0x01\r\n    packet.continuityCounter = (continuityCounter++) % 16\r\n    writeTSPacket(ioWriter, packet, mpegtsContext)\r\n\r\n    packet.continuityCounter = continuityCounter % 16\r\n\r\n    return\r\n  }\r\n\r\n  const len = mpegts.TS_PACKET_SIZE - (4 + adaptationFieldLength)\r\n\r\n  let pos = 0\r\n\r\n  const payload = packet.payload\r\n  while (pos < payload.length) {\r\n    let next = Math.min(pos + len, payload.length)\r\n    if (pos === 0) {\r\n      packet.payloadUnitStartIndicator = 0x01\r\n    }\r\n    else {\r\n      packet.payloadUnitStartIndicator = 0x00\r\n    }\r\n\r\n    const currentLen = next - pos\r\n\r\n    if (currentLen + 4 === mpegts.TS_PACKET_SIZE) {\r\n      packet.adaptationFieldControl = 0x01\r\n    }\r\n    else if (adaptationFieldLength === 0 && currentLen + 4 + 1 === mpegts.TS_PACKET_SIZE) {\r\n      // adaptationFieldLength  2 byte\r\n      next--\r\n    }\r\n\r\n    packet.payload = payload.subarray(pos, next)\r\n    packet.continuityCounter = (continuityCounter++) % 16\r\n\r\n    writeTSPacket(ioWriter, packet, mpegtsContext)\r\n    pos = next\r\n  }\r\n\r\n  packet.continuityCounter = continuityCounter % 16\r\n}\r\n","/*\r\n * libmedia mpegts struct defined\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport { NOPTS_VALUE, NOPTS_VALUE_BIGINT } from 'avutil/constant'\r\nimport { TSStreamType } from './mpegts'\r\nimport { PID } from './type'\r\n\r\nexport class TSPacketAdaptationFieldInfo {\r\n  discontinuityIndicator: number = 0\r\n  randomAccessIndicator: number = 0\r\n  elementaryStreamPriorityIndicator: number = 0\r\n  pcrFlag: number = 0\r\n  opcrFlag: number = 0\r\n  splicingPointFlag: number = 0\r\n  transportPrivateDataFlag: number = 0\r\n  adaptationFieldExtensionFlag: number = 0\r\n  pcr: bigint = 0n\r\n  opcr: bigint = 0n\r\n  spliceCountDown: number = 0\r\n  transportPrivateData: Uint8Array = null\r\n  extension: Uint8Array = null\r\n}\r\n\r\nexport class TSPacket {\r\n  pos: bigint = NOPTS_VALUE_BIGINT\r\n  payloadUnitStartIndicator: number = 0\r\n  transportPriority: number = 0\r\n  pid: PID = NOPTS_VALUE\r\n  adaptationFieldControl: number = 0\r\n  continuityCounter: number = 0\r\n  transportScramblingControl: number = 0\r\n  adaptationFieldInfo: TSPacketAdaptationFieldInfo = new TSPacketAdaptationFieldInfo()\r\n  payload: Uint8Array = null\r\n}\r\n\r\nexport class TSSliceQueue {\r\n  slices: Uint8Array[] = []\r\n  totalLength: number = 0\r\n  expectedLength: number = NOPTS_VALUE\r\n  randomAccessIndicator: number = 0\r\n  pid: PID = NOPTS_VALUE\r\n  streamType: TSStreamType = TSStreamType.NONE\r\n  pos: bigint = NOPTS_VALUE_BIGINT\r\n}\r\n\r\nexport class PAT {\r\n  versionNumber: number = 0\r\n  networkPid: PID = NOPTS_VALUE\r\n  program2PmtPid: Map<number, PID> = new Map()\r\n}\r\n\r\nexport class SectionPacket extends TSPacket {\r\n}\r\n\r\nexport class ESDescriptor {\r\n  tag: number\r\n  buffer: Uint8Array\r\n}\r\n\r\nexport class PMT {\r\n  versionNumber: number = 0\r\n  programNumber: number = 0\r\n  pcrPid: PID = 0\r\n  pid2StreamType: Map<number, TSStreamType> = new Map()\r\n  pid2ESDescriptor: Map<number, ESDescriptor[]> = new Map()\r\n}\r\n\r\nexport class PES {\r\n  pid: PID = NOPTS_VALUE\r\n  streamType: TSStreamType = TSStreamType.NONE\r\n  streamId: number = NOPTS_VALUE\r\n  dts: bigint = NOPTS_VALUE_BIGINT\r\n  pts: bigint = NOPTS_VALUE_BIGINT\r\n  pos: bigint = NOPTS_VALUE_BIGINT\r\n  payload: Uint8Array = null\r\n  data: Uint8Array = null\r\n  randomAccessIndicator: number = 0\r\n}\r\n","/*\r\n * libmedia string tag to uint32 in big end\r\n *\r\n *  (C) 2024 \r\n * Copyright (C) 2024 Gaoxing Zhao\r\n *\r\n *  libmedia \r\n * This file is part of libmedia.\r\n * \r\n * libmedia  GNU Lesser General Public LicenseGNU LGPL3.1\r\n * \r\n * libmedia is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 3.1 of the License, or (at your option) any later version.\r\n * \r\n * libmedia \r\n *  libmedia  GNU Lesser General Public License \r\n * libmedia is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n */\r\n\r\nimport * as logger from 'common/util/logger'\r\n\r\nexport default function mktag(tag: string): number {\r\n  if (tag.length !== 4) {\r\n    logger.warn(`tag length is not 4, tag: ${tag}`)\r\n  }\r\n\r\n  let value = 0\r\n  for (let i = 0; i < 4; i++) {\r\n    value = (value << 8) | tag.charCodeAt(i)\r\n  }\r\n\r\n  return value\r\n}\r\n"],"names":[],"sourceRoot":""}